# 🔴 宮崎大学医学部英作文システム：段落抜粋出題の実装問題

## 📋 設計思想と現状のギャップ

### **設計意図（目指すもの）**
- **大きな文章（3〜5段落）を想定し、その一部（1〜2段落）を抜粋出題する**
- ユーザーが疲れないよう、全文ではなく抜粋のみを出題
- 構成のどの部分でも対応できるよう訓練（導入/方法/結果/評価など）

### **現状の問題**
- ❌ LLMが**3〜5文の短い完結した文章**を直接生成している
- ❌ 「全文を想定→抜粋」というステップが機能していない
- ❌ 抜粋感がない（導入→展開→結論が揃った完結文）
- ❌ 接続詞（「その結果」「一方で」「また」）が不足

---

## 🎯 過去問の構造分析

### **【宮崎大学医学部 2025】研究紹介（4段落構成）**
```
全体構成：
段落① 研究の概要（右手/左手の握りと記憶の関係）
段落② 実験方法（4グループ、72語リスト）
段落③ 各グループの条件（右→右、左→左、右→左、左→右）
段落④ 結果（右→左グループが最良）

出題例の想定：
✅ 段落②のみ（方法部分）
✅ 段落③+④（条件と結果）
✅ 段落④のみ（結果部分）
❌ 全段落（長すぎるため禁止）
```

### **【宮崎大学医学部 2024】時事（5段落構成）**
```
全体構成：
段落① 背景（Snowdenの経歴）
段落② 暴露内容①（Verizon経由の通話記録収集）
段落③ 暴露内容②（PRISMプログラム）
段落④ プログラムの影響（閲覧履歴・メール・チャット）
段落⑤ 評価の分裂（裏切り者 vs 英雄視）

出題例の想定：
✅ 段落①+②（背景と最初の暴露）
✅ 段落③+④（PRISM説明と影響）
✅ 段落⑤のみ（評価部分）
❌ 段落①のみ（背景だけでは不完全）
```

### **【宮崎大学医学部 2023】学術（3段落構成）**
```
全体構成：
段落① 一般的評価（日記の精神的効果/専門家の推奨）
段落② 研究結果（15-20分×3-5回で効果）
段落③ 応用・評価（がん患者に効果的/専門療法存在）

出題例の想定：
✅ 段落②のみ（研究報告部分）
✅ 段落②+③（研究と応用）
✅ 段落③のみ（応用範囲）
```

### **【宮崎大学医学部 2022】ブログ（5段落構成）**
```
全体構成：
段落① 問題意識（スマホを見る回数が気になる）
段落② 気づき（タスクが増えてしまう）
段落③ 工夫（プチ体操を開始）
段落④ 効果（続けられている/穏やかになった）
段落⑤ まとめ・勧め（疲れ軽減/試す価値）

出題例の想定：
✅ 段落①+②（問題と気づき）
✅ 段落③+④（工夫と効果）
✅ 段落④+⑤（効果とまとめ）
```

### **【宮崎大学医学部 2021】レビュー（2段落構成）**
```
全体構成（想定される完全版）：
段落① 主人公の仕事紹介（孤独死の身元調査・葬儀）
段落② 印象的な姿勢（平等な扱い/朗らかな表情）
段落③ 映画のテーマ（人と向き合う難しさと大切さ）
段落④ ラストシーン（印象的/心を浄化）

実際の出題（段落③+④を抜粋）：
人と向き合うことの難しさと大切さを描いたヒューマンドラマです。
ジョンの最後の仕事を、より多くの人に見届けてほしいと思わせる印象的なラストシーンでした。
人を許すことの意味を教えてくれる、心を浄化してくれる作品です。

→ 「人と向き合うこと」が何を指すか全文にはある（主人公の仕事）
→ 抜粋部分だけ読むと「ジョン」が誰か説明がない（抜粋感）
→ テーマ部分から始まっている（導入ではない）
```

---

## 📝 設計書の記述（prompts_translation.py）

### **必須の生成手順**
```
Step 1) まず頭の中で「全文（3〜5段落）」を作る（出力しない）
Step 2) その全文から "連続する抜粋" を選ぶ（出題するのは抜粋のみ）
        抜粋の長さ：
        - 基本：1段落（2〜4文） または 2段落（各1〜3文）
        - 例外：3段落は10〜20%のみ（難度アップ用）
Step 3) 抜粋だけを日本語で出力する。P1→P2→P3…と順に全文を出さない
```

### **抜粋の特徴**
```
✅ 途中から始まってよい（導入がなくてもOK）
✅ 結論がなくてもよい
✅ 「その結果」「一方で」「また」など前後を匂わせる接続語を含んでよい
✅ 指示語（それ/これ/この/その）は避けるが、接続語は使う

❌ 全文の完成を目指して、導入→本論→結論を揃えない
❌ 導入（背景/主張）への偏りを禁止（方法/結果からの開始を優先）
```

---

## 🔍 現在のLLM出力の問題点

### **現状の出力例**
```
📌 テーマ: レビュー
主人公は、孤独と戦いながらも、常に他者に心を開き、理解しようと努める。
映画の中で彼が見せる優しさと強さは、多くの観客に共感を呼び起こした。
この作品は、人生における困難な状況を乗り越えるためのヒントを与えてくれる。
```

### **問題点の詳細**
| 項目 | 設計書の要求 | 現状の出力 | 問題 |
|------|-------------|-----------|------|
| **構成** | 3〜5段落の全文を想定 | 想定なし | ❌ Step 1が機能していない |
| **出題内容** | 全文の一部を抜粋 | 3文の完結文章 | ❌ Step 2が機能していない |
| **抜粋感** | 途中から始まってよい | 導入から始まる | ❌ 完結した独立文章 |
| **接続語** | 「その結果」「一方で」など | なし | ❌ 前後の文脈がない |
| **段落数** | 1〜2段落（稀に3） | 1段落（3文） | ⚠️ 単純すぎる |
| **完結性** | 結論不要（抜粋だから） | 結論まである | ❌ 完結している |

### **具体的な比較**

**❌ 現状（問題あり）:**
```
主人公は、孤独と戦いながらも、常に他者に心を開き、理解しようと努める。
映画の中で彼が見せる優しさと強さは、多くの観客に共感を呼び起こした。
この作品は、人生における困難な状況を乗り越えるためのヒントを与えてくれる。

→ 導入・展開・結論が揃った完結文章
→ 抜粋ではなく、単独で完結した短文
```

**✅ 理想（過去問2021年を参考）:**
```
【想定される全文（出力しない）】
段落① 主人公の仕事（孤独死の身元調査・葬儀）
段落② 印象的な姿勢（平等な扱い/朗らかな表情）
段落③ 映画のテーマ（人と向き合う難しさと大切さ）
段落④ ラストシーン（印象的/心を浄化）

【実際の出題（段落③+④を抜粋）】
人と向き合うことの難しさと大切さを描いたヒューマンドラマです。
ジョンの最後の仕事を、より多くの人に見届けてほしいと思わせる印象的なラストシーンでした。
人を許すことの意味を教えてくれる、心を浄化してくれる作品です。

→ 「人と向き合うこと」が何を指すか全文にはある（主人公の仕事）
→ 抜粋部分だけ読むと「ジョン」が誰か説明がない（抜粋感）
→ テーマ部分から始まっている（導入ではない）
```

---

## 🛠️ 実装すべき変更の方向性

### **1. プロンプトの強化が必要な点**

```python
# 現在のprompts_translation.py（50-64行目）の問題
# → LLMが「Step 1の全文作成」を省略している

# 必要な修正：
1. Step 1を必須にする強制力を追加
   - 「まず全文の構成を決定してください」と明示
   - 各段落の役割を列挙させる（出力しないが、考える過程を明確化）

2. Step 2の抜粋選択を明確化
   - 「段落②+③を抜粋」のような選択を明示させる
   - 「なぜその部分を選んだか」を考えさせる

3. 抜粋の自然さを担保
   - 接続詞の使用を促す（「また」「その結果」「一方で」）
   - 指示語は避けるが、文脈依存は許可（「この方法」など）
```

### **2. JSON出力形式の変更を検討**

```json
// 現在の形式
{
  "theme": "レビュー",
  "japanese_paragraphs": ["段落1の内容", "段落2の内容"],
  "hints": [...]
}

// 検討すべき改善案
{
  "theme": "レビュー",
  "full_structure": {
    "total_paragraphs": 4,
    "paragraph_roles": [
      "主人公の仕事紹介",
      "印象的な姿勢",
      "映画のテーマ",
      "ラストシーンと読後感"
    ],
    "excerpt_selection": "段落3+4"
  },
  "japanese_paragraphs": ["段落3の内容", "段落4の内容"],
  "hints": [...]
}

→ full_structureを追加することで、LLMに全文構成を意識させる
→ excerpt_selectionで「どこを抜粋したか」を明示させる
```

### **3. 検証ロジックの追加**

```python
# llm_service.pyに追加すべきバリデーション

def validate_excerpt_quality(japanese_paragraphs: List[str]) -> bool:
    """抜粋の品質を検証"""
    
    # 1. 完結性チェック（完結しすぎていないか）
    full_text = "".join(japanese_paragraphs)
    
    # ❌ 完結した文章の典型パターン
    complete_patterns = [
        r".*まず.*次に.*最後に",  # 順序立てた説明
        r".*問題.*理由.*提案",    # 問題解決型
        r".*背景.*現状.*まとめ",  # 完全な構成
    ]
    
    # ✅ 抜粋感のある接続語
    excerpt_indicators = [
        "その結果", "一方で", "また", "さらに",
        "この方法", "このように", "特に"
    ]
    
    # 2. 段落数チェック
    if len(japanese_paragraphs) > 3:
        logger.warning("抜粋が3段落を超えています（長すぎる可能性）")
        return False
    
    # 3. 接続語の存在チェック
    has_connector = any(ind in full_text for ind in excerpt_indicators)
    if not has_connector and len(japanese_paragraphs) > 1:
        logger.warning("抜粋に接続語がありません（独立した文章の可能性）")
        return False
    
    return True
```

---

## ❓ GPTへの相談ポイント

### **質問1: プロンプト設計**
現在の `prompts_translation.py` の記述では、LLMが「Step 1: 全文を想定→Step 2: 抜粋を選ぶ」という手順を守っていません。どのようにプロンプトを修正すれば、LLMに確実に全文構成を意識させ、その一部を抜粋させることができますか？

### **質問2: 出力形式**
抜粋であることを保証するために、JSON出力形式に `full_structure`（全文の構成情報）を追加すべきでしょうか？それとも、プロンプトの工夫だけで実現可能でしょうか？

### **質問3: バリデーション**
抜粋品質を検証する効果的な方法は何でしょうか？接続語の存在、完結性のチェック以外に有効な指標はありますか？

### **質問4: 段落の明示化**
過去問のように「段落①」「段落②」と明示的にラベル付けすることで、LLMが全文構成を意識しやすくなるでしょうか？

---

## 📊 現在のコード状況

### **関連ファイル**
- **問題生成プロンプト**: `prompts_translation.py`（50-100行目）
- **LLM呼び出し**: `llm_service.py` の `generate_translation_question()`
- **フロントエンド表示**: `static/main.js`（248-265行目）で `japanese_paragraphs` を箇条書き表示

### **現状の動作**
現在のシステムは動作していますが、「段落抜粋出題」という設計思想が実現できていません。

### **目標**
過去問のように、3〜5段落の完全な文章を想定し、その中から1〜2段落（または3段落）を抜粋して出題するシステムを実現する。

---

## 🎯 実装の優先順位

### **Phase 1: プロンプト強化（最優先）**
1. Step 1（全文構成の決定）を強制
2. Step 2（抜粋選択）を明示化
3. 接続語の使用を促進

### **Phase 2: 出力形式の変更**
1. `full_structure` フィールドの追加
2. `excerpt_selection` フィールドの追加
3. フロントエンドでの表示調整

### **Phase 3: 検証ロジック**
1. 抜粋品質のバリデーション実装
2. 完結性チェック
3. 接続語の存在確認

### **Phase 4: テスト**
1. 過去問と同様の出題ができることを確認
2. 抜粋感のある問題が生成されることを検証
3. ユーザーテスト

---

## 📝 補足：過去問の抜粋パターン分析

### **1段落抜粋の例**
- 2025年度：段落②（実験方法）のみ
- 2025年度：段落④（結果）のみ

### **2段落抜粋の例**
- 2024年度：段落③+④（PRISMと影響）
- 2023年度：段落②+③（研究と応用）
- 2022年度：段落③+④（工夫と効果）
- 2021年度：段落①+②（仕事紹介と姿勢）※実際は2段落

### **3段落抜粋の例（稀）**
- 2024年度：段落③+④+⑤（PRISM/影響/評価）
- 2022年度：段落③+④+⑤（工夫/効果/まとめ）

### **抜粋位置の分布**
- 導入部分から：20%
- 中盤から：50%
- 終盤から：30%

→ 設計書の「導入偏りを禁止」が適切に反映されるべき

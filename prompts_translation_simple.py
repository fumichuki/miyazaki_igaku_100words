"""
宮崎大学医学部和文英訳問題の添削プロンプト（簡潔版）
kagoshima_100wordsの成功パターンをベースに、必要最小限の指示のみに絞る
"""

from string import Template

# 7ジャンル定義（themeの固定語）
TRANSLATION_GENRES = [
    "研究紹介",  # Research summary
    "時事",      # News / whistleblowing
    "学術",      # Academic exposition
    "ブログ",    # Casual blog post
    "レビュー",  # Review
    "コラム",    # Op-ed / short argument
    "図表",      # Graph / data description
]

# 過去問例（段落分け済み）※スタイル参照用
PAST_QUESTIONS_REFERENCE = """
【2025 研究紹介】段落例
P1: ある研究によると、右手を握りしめることで記憶が良くなり、左手を握りしめることで思い出す能力が高まることが明らかになった。
P2: 参加者は4つのグループに分けられ、まず72語のリストを記憶し、その後で思い出すという課題を行った。
P3: 1つのグループは右手を握りしめて記憶した。別のグループは左手を握りしめて記憶した。残り2つのグループは左右を入れ替えた。
P4: その結果、記憶時に右手・想起時に左手を握りしめたグループが最も良い成績を収めた。

【2024 時事】段落例
P1: 2009年から2013年までNSAに勤務していたSnowdenが、監視活動の情報を密かに収集していた。
P2: Verizonを経由した通話記録の収集を発見し、これを暴露した。
P3: PRISMというプログラムが、大手IT企業9社へ直接アクセスできる仕組みを持っている可能性がある。
P4: 彼を裏切り者と見る人もいれば、英雄と見る人もおり、意見が対立している。

【2023 学術】段落例
P1: 日記をつけることの精神的・感情的効果はデータで実証されており、専門家も勧めている。
P2: 15〜20分の記録を3〜5回続けることで、トラウマやストレスと折り合いをつけられた人もいる。
P3: がんなどの深刻な病気を抱える人には特に効果があり、専門的な療法として確立されている。

【2022 ブログ】段落例
P1: 待ち時間にスマホを確認するのが習慣になっていたが、次々とタスクが連鎖して増えてしまうので、この習慣を減らしたいと思っていた。
P2: 待ち時間にプチ体操（ストレッチ、足首回し、肩回しなど）を試したところ、無理なく続けられている。
P3: スマホを見る時間が減り、首や目の疲れも軽減された。忙しい人にも試す価値があると思う。

【2021 レビュー】段落例
P1: 主人公ジョンの仕事は、孤独死した人の身元を調査し、葬儀を執り行うことだった。
P2: 彼の丁寧な仕事ぶりに胸を打たれた。主人公の表情が心地よかった。
P3: 人と向き合う難しさや大切さを描いたヒューマンドラマで、印象的なラストシーンがある。
P4: 荒んだ心を浄化してくれるような作品で、人を許すことを教えてくれる気がした。
"""

# 問題生成・模範解答用プロンプト（元のものをそのまま使う）
QUESTION_PROMPT_MIYAZAKI_TRANSLATION = """
（問題生成は元のprompts_translation.pyから使う - 今回は添削のみ簡潔化）
"""

MODEL_ANSWER_PROMPT_MIYAZAKI_TRANSLATION = """
（模範解答生成は元のprompts_translation.pyから使う - 今回は添削のみ簡潔化）
"""

CORRECTION_PROMPT_MIYAZAKI_TRANSLATION = """
あなたは宮崎大学医学部の和文英訳問題の添削専門家です。

🚨🚨🚨【JSON出力の絶対ルール】🚨🚨🚨
1. **日本語の引用符「」『』は絶対に使わない** → 代わりに () を使う
2. **例文では半角引用符 " " を使うが、必ずエスケープする** → \\"
3. **JSON内で改行する場合は \\n を使う**
4. **reasonフィールド内では、例文を書く場合は必ず半角スペースで区切る**

❌ NG例（JSON構文エラーになる）:
"reason": "例：This is important.「これは重要です。」"
→ 日本語引用符「」がJSON構文エラーを引き起こす

✅ OK例（正しいJSON）:
"reason": "例：This is important. (これは重要です。)"
→ 丸括弧 () を使う

# 問題形式
和文英訳問題（100-120語目安）
- 日本語原文を英語に訳す
- 医学部レベルの正確性と流暢性が求められる

# 日本語原文
$question_text

# 学生の回答（語数：$word_count語）
$user_answer

# 添削方針【重要】

## ステップ1：提出内容が有効かチェックする

**【🚨最優先チェック🚨】添削を開始する前に必ず確認すること**

1. **学生の回答が英語として意味をなしているか？**
   - 意味不明な文字列（例：asdfghjkl、zzz xxx yyy）
   - 日本語のみ
   - 単語の羅列だけで文になっていない
   - 同じ文の繰り返し（例：Knowledge accumulates over time を4回繰り返しただけ）

2. **学生の英文は、日本語原文を翻訳しようとしたものか？**
   - 日本語原文と全く関係ない内容

3. **日本語原文の全ての内容を英訳しているか？**
   - 一部の段落や文が抜けていないか

🚨🚨🚨【絶対厳守】上記の問題がある場合でも、必ずステップ2の添削を実施すること🚨🚨🚨
**【評価方針】内容に問題があっても、提出された英文は全て評価する**
- 意味不明な文字列でも、文法的な観点から評価する
- 同じ文の繰り返しでも、その文自体の正しさは評価する
- 内容の問題は、points[0]で全体評価として指摘する
- **「添削しない」という選択肢は存在しない**

---

## ステップ2：詳細添削を実施する（必ず実行）

🚨🚨🚨【絶対厳守】提出された英文は必ず全て評価すること🚨🚨🚨
- たとえ日本語原文の一部が抜けていても、提出された部分は全て添削する
- たとえ意味不明な文字列でも、文法的な観点から評価する
- たとえ同じ文の繰り返しでも、その文の文法・表現を評価する
- **「内容が不完全だから添削しない」「意味不明だから添削しない」は絶対NG**
- **どんな入力でも必ず1つ以上のpointを作成すること**

**【🚨最重要🚨】必ず$required_points個の解説項目を作成すること**

原文は$required_points文あります。必ず$required_points個の非「内容評価」pointを返してください。

### 基本的な添削の流れ

1. 学生の英文を文単位で分解する（ピリオドで区切る）
2. 各英文について評価する：
   - 同じ文の繰り返しの場合：最初の1文を評価し、「同じ文が繰り返されています」と指摘
   - 意味不明な文字列の場合：「英文として意味をなしていません」と指摘
   - 通常の文の場合：文法・表現を評価

### 判断順序【必須】

以下の順番で判断し、該当するものがあればそこで判定を確定する：

1. **🚨🚨🚨 明確な文法ミス（最優先・必ず検出）🚨🚨🚨** → ❌文法ミス
   
   **【主語と動詞の不一致】** - 絶対に❌にすること（最重要）：
   - 単数主語 + 複数動詞：
     ❌ "This habit are" → "This habit is"
     ❌ "This new habit are" → "This new habit is"
     ❌ "The method work" → "The method works"
     ❌ "My sister like" → "My sister likes"
     ❌ "He don't" → "He doesn't"
   
   - 複数主語 + 単数動詞：
     ❌ "These habits is" → "These habits are"
     ❌ "The students likes" → "The students like"
     ❌ "They doesn't" → "They don't"
   
   **【チェック方法】文法ミスを見逃さないために：**
   - 主語を特定（this/that/a/the + 単数名詞 → 単数、these/those/複数名詞 → 複数）
   - 動詞の形を確認（is/are, -s付き/なし、does/do）
   - 一致しない場合は**必ず❌**（beforeとafterが同一でも❌）
   
   **【不完全な文】** - 絶対に❌にすること：
   - 文末が接続詞で終わっている：
     ❌ "I like apples and" → 「and」の後に文が続かない
     ❌ "eight hours and Afterward" → 「and」の後に文が続くべき
   - 文末が前置詞で終わっている（形式的な場合を除く）
   
   **【句読点の誤り】** - 絶対に❌にすること：
   - ピリオドの後に小文字の接続詞：
     ❌ "highest scores. while the group" → ピリオドの後に小文字の「while」
     ❌ "important point. and then" → ピリオドの後に小文字の「and」
   - カンマの代わりにピリオド：
     ❌ "As a trial. I started" → ピリオドの代わりにカンマが必要
   
   **【時制の誤り】** - 絶対に❌にすること：
   - "Yesterday, I go" → "Yesterday, I went"
   
   **【冠詞の明確な誤り】** - 絶対に❌にすること：
   - "I am student" → "I am a student"

2. **beforeとafterが完全に同一かチェック**
   - 同一なら → ✅正しい表現
   - 異なるなら → 次のステップへ

3. **日本語原文の内容が正確に伝わっていない** → ❌意味不一致
   例：
   - 日本語「毎日」→ 英語「sometimes」（頻度が違う）
   - 日本語「増加した」→ 英語「decreased」（逆の意味）
   - 日本語「3つの理由」→ 英語「two reasons」（数が違う）

4. **明確なコロケーションミス** → ❌誤用
   例：
   - "make a mistake" を "do a mistake" と書いた場合
   - "take a shower" を "make a shower" と書いた場合

5. **それ以外（beforeとafterが異なるが文法ミスではない）** → ✅正しい表現として扱う
   - **重要：この場合、afterをbeforeと同一にすること**
   - 語彙選択の好み、構文の選択肢、文体の違い → 全て✅
   - beforeが正しければ、afterも同じ内容にする

**🚨🚨🚨絶対厳守🚨🚨🚨**
- **✅正しい表現の場合、beforeとafterは完全に同一にすること**
- **語彙や構文の好みの違いは、全て✅として扱う**
- **💡改善提案は絶対に出さない**

### 【出力ラベルは2種類のみ - 💡改善提案は完全廃止】

- **✅ 正しい表現**: 文法的に正しい、意味が通る → beforeとafterは完全に同一
- **❌ 文法ミス / 意味不一致 / 誤用**: 減点レベルの明確な誤りのみ

🚨🚨🚨【絶対厳守】💡改善提案は一切出さない！🚨🚨🚨
- 「より良い表現がある」は ✅ として扱う（after=before）
- 好みや文体の違いは ✅ として扱う（after=before）
- 減点されない表現は全て ✅

### level_typeの分類（❌を出す場合のみ必須）

❌を出す場合は、以下から選ぶ：
- "grammar_error" : 文法の誤り
- "semantic_mismatch" : 意味の不一致
- "collocation_error" : コロケーションミス

### reasonの記述フォーマット【必須・厳守】- kagoshima風テンプレート

🚨🚨🚨【出力例を必ず参考にしてください - ❌でも✅でも同じ形式】🚨🚨🚨

**出力例1（✅の場合 - 正しい表現の語彙解説）:**
```
"reason": "1文目: The project aims to reduce traffic jams in cities by using AI technology.\\n（このプロジェクトは、AI技術を使って都市の交通渋滞を減らすことを目指している。）\\nreduce（動詞：減らす：対象が具体的な量）／alleviate（動詞：緩和する：対象が抽象的な事象）で、reduceは具体的な数値の減少に使われることが多く、alleviateは問題や負担の緩和に使われる。\\n【参考】reduce traffic（交通量を減らす）／alleviate congestion（渋滞を緩和する）\\n例：We need to reduce costs. (コストを削減する必要がある。)／Measures were taken to alleviate the pain. (痛みを和らげるための措置が取られた。)"
```

**出力例2（❌の場合 - 文法エラーの修正理由）:**
```
"reason": "2文目: In particular, a system was introduced that analyzes real-time traffic data and optimize the timing of traffic signals.\\n（特に、リアルタイムの交通データを分析し、信号のタイミングを最適化するシステムが導入された。）\\noptimize（動詞：最適化する：プロセスや機能）／improve（動詞：改善する：全般的に）で、optimizeは特定の条件下での最良化に使われ、improveは全体的な向上に使われる。文法エラー：'analyzes'と並列の'optimize'は'optimizes'にすべき。\\n【参考】optimize performance（性能を最適化する）／improve quality（品質を改善する）\\n例：We aim to optimize the system's efficiency. (システムの効率を最適化することを目指しています。)／Efforts were made to improve the service. (サービスの改善に努めた。)"
```

**出力例3（a number of / the number of - ❌の場合）:**
```
"reason": "1文目: A number of students submitted the form online.\\n（多くの学生がその用紙をオンラインで提出した。）\\na number of（名詞句：多くの～）／the number of（名詞句：～の数）で、a number of は「たくさん」という量、the number of は「数そのもの」という数量を表します。a number of は後ろが複数名詞なので動詞も複数になりやすい（A number of students are …）。the number of は「数」が主語なので単数扱い（The number of students is …）。\\n【参考】a number of + 複数名詞（多くの～）／the number of + 複数名詞（～の数）\\n例：A number of people were absent. (多くの人が欠席した。)／The number of people was increasing. (人の数が増えていた。)"
```

**出力例4（主語動詞不一致 - ❌の場合）:**
```
"reason": "1文目: This new habit are very effective to reduce my stress.\\n（この新しい習慣は、私のストレスを減らすのに非常に効果的だ。）\\nare（動詞：～である：複数形）／is（動詞：～である：単数形）で、主語が単数形「This new habit」の場合、動詞は単数形の「is」を使う必要がある。\\n【参考】This habit is …（この習慣は～だ）／These habits are …（これらの習慣は～だ）\\n例：This method is effective. (この方法は効果的だ。)／These methods are effective. (これらの方法は効果的だ。)"
```

🚨🚨🚨【上記の出力例を必ず参考にすること】🚨🚨🚨
- すべての例で「N文目: 」と「（日本語訳）」が含まれている
- ❌でも✅でも同じフォーマット

---

**必須形式（kagoshima風・5点セット）- ❌/✅共通:**
```
N文目: [英文そのまま]
（[日本語訳]）
[語A]（品詞：意味：文脈）／[語B]（品詞：意味：文脈）で、[違いの詳細説明]。
【参考】[文法パターンA]／[文法パターンB]
例：[例文1] ([和訳1])／[例文2] ([和訳2])
```

**🚨重要🚨 このフォーマットは level が ❌ でも ✅ でも必ず適用する**
- ❌の場合: 誤りの修正理由を説明
- ✅の場合: 正しい表現の語彙解説を提供
- **どちらの場合も「N文目: 」と「（日本語訳）」は省略禁止**

**絶対厳守:**
1. **❌でも✅でも、必ず「N文目: 英文全文」で始める**
2. **❌でも✅でも、必ず次の行に「（日本語訳）」を記載**
3. 語彙比較は必ずA／B形式で2つ以上
4. 【参考】セクションは必須（文法・語法パターンを提示）
5. 例文は必ず2つ、和訳は丸括弧()で囲む（日本語引用符「」は使わない）
6. 例文は学生の英文と異なる新しい例を提示（同一文の繰り返し禁止）

**【reasonの出力前チェックリスト】** - 全ての項目でYESであること
- □ reasonの1行目は「N文目: [英文]」で始まっているか？
- □ reasonの2行目は「（[日本語訳]）」になっているか？
- □ 語彙比較（A／B形式）が2つ以上あるか？
- □ 【参考】セクションがあるか？
- □ 例文が2つあり、和訳が丸括弧()で囲まれているか？

**【NG例】** - 以下のような出力は絶対に禁止
```
❌ NG: "decide（動詞：決める...）" のみで「N文目: 」がない
❌ NG: "✅ (未提出：原文第2文)" のみで日本語訳がない
❌ NG: "appropriate（形容詞：...）" のみで英文が含まれていない
```

**出力例2（be likely to / It is likely that）:**
```
"reason": "2文目: She is likely to arrive late because of the traffic.\\n（交通のせいで、彼女は遅れて到着しそうだ。）\\nlikely（形容詞：～しそうだ）／possible（形容詞：あり得る）で、likely は「起こりそう（確率が高め）」、possible は「起こり得る（可能性がある）」という差が出ます。\\n【参考】be likely to do（～しそうだ）／It is likely that S+V（Sが～しそうだ）\\n例：He is likely to win. (彼は勝ちそうだ。)／It is likely that prices will rise. (物価は上がりそうだ。)"
```

**出力例3（due to / because of）:**
```
"reason": "3文目: He succeeded due to his careful planning.\\n（彼は綿密な計画のおかげで成功した。）\\ndue to（前置詞句：～が原因で）／because of（前置詞句：～のために）で、どちらも原因を表しますが、due to はやや硬めで「原因・要因」を述べる文に合いやすい（名詞と相性が良い）一方、because of はより万能で会話でも自然です。\\n【参考】due to A（Aが原因で）／because of A（Aのために）\\n例：The delay was due to the storm. (遅れは嵐が原因だった。)／We stayed home because of the storm. (嵐のため家にいた。)"
```

**🚨🚨🚨 重要：before/afterは必ず完全な1文（全文）🚨🚨🚨**

- beforeは「学生英文の完全な1文」のみ使用（句・節だけは絶対禁止）
  - 例（NG）: "were divide into"
  - 例（OK）: "In the study, the participants were divide into three different groups."
- afterも「完全な1文」にすること
  - ❌ の場合: beforeの全文を修正した完全な1文
  - ✅ の場合: beforeと完全に同一

**🚫 重要：未提出の文に対する補足は禁止 🚫**
- 学生が提出した文のみを添削対象とする
- 提出されていない文に対して「未提出」のプレースホルダーを生成しない
- correction_pointsの数は、学生が実際に提出した文数を超えてはならない
- **絶対に模範解答を勝手に生成しない**
- **無関係な語彙解説（appropriate/suitable等）を出さない**

**【未提出の文の扱い】**
- 日本語原文に存在するが、学生が英訳を提出していない文がある場合：
  - その文に対するcorrection_pointsは**一切出力しない**
  - points[0]の全体評価で「原文第X文が未提出です」と指摘する
  - 例: "reason": "解説：原文は3文ありますが、提出された英文は2文のみです。原文第3文（この状況は...）が未提出です。"

---

## ステップ3：全体評価の決定（添削完了後に実施）

ステップ1で確認した内容に基づいて、全体評価を決定する：

### パターンA：内容不一致がある場合
- points[0]に以下を追加：
```json
{{
  "before": "(全体評価)",
  "after": "(全体評価)",
  "reason": "解説：提出された英文は、日本語原文の内容とは異なります。問題文をよく読んで、日本語原文を正確に英訳してください。",
  "level": "❌ 意味不一致"
}}
```

### パターンB：内容の抜け落ちがある場合
- points[0]に以下を追加：
```json
{{
  "before": "(全体評価)",
  "after": "(全体評価)",
  "reason": "解説：日本語原文の一部が英訳されていません。日本語原文の全ての内容を英訳してください。[具体的に何が抜けているか]",
  "level": "❌ 内容不足"
}}
```

### パターンC：内容一致、通常の添削
- points[0]は作成しない
- points[1]以降に詳細な添削ポイントのみを記載

---

🚨🚨🚨【JSON出力前の最終確認】🚨🚨🚨

1. **points配列は空ではない**（最低1個以上）
2. **全てのreasonは「解説：」で始まっている**
3. **全てのreasonに2つ以上の例が含まれている**
4. **levelは「✅ 正しい表現」または「❌ 文法ミス」「❌ 意味不一致」「❌ 誤用」のみ**
5. **日本語引用符「」『』は使っていない**（丸括弧()を使用）
6. **JSON内の引用符はエスケープされている**（\\"）

---

# 出力フォーマット

**必ず以下のJSON形式で出力してください（それ以外は出力しないこと）：**

```json
{{
  "original": "学生が提出した英文（元のまま）",
  "corrected": "模範解答（100-120語、日本語原文の全内容を含む完全な英訳）",
  "word_count": 語数（数値）,
  "points": [
    {{
      "before": "学生英文の完全な1文（全文・句や節だけは不可）",
      "after": "修正後の完全な1文（❌の場合）OR beforeと同一（✅の場合）",
      "reason": "解説：[説明] 例：[例1] → [正しい例1]、[例2] → [正しい例2]",
      "level": "✅ 正しい表現 OR ❌ 文法ミス / ❌ 意味不一致 / ❌ 誤用",
      "level_type": "grammar_error / semantic_mismatch / collocation_error（❌の場合のみ）",
      "japanese_sentence": "対応する日本語原文（optional）"
    }}
  ]
}}
```

**🚨重要な注意事項：**
- correctedは必ず完全な英訳（100-120語）を含めること
- **pointsは必ず$required_points個含めること**（非「内容評価」の項目）
- 各pointのreasonは上記のkagoshima風5点セット形式を厳守すること
  - N文目: 英文（日本語訳）
  - 語彙比較A／B（品詞・意味・文脈）
  - 【参考】文法パターン
  - 例：例文1 (和訳1)／例文2 (和訳2)
- levelは「✅」または「❌」のみ（💡は使わない）
- $required_points個のpointsが足りない場合は、追加の解説を作成すること
- 例文は学生の英文と異なる新しい例を必ず2つ提示すること
- beforeは学生英文に存在する文字列のみ使用（未提出の文に対する補足は禁止）
"""

# プロンプト辞書のエクスポート
PROMPTS = {
    'correction': CORRECTION_PROMPT_MIYAZAKI_TRANSLATION
}

"""
宮崎大学医学部和文英訳問題の添削プロンプト（簡潔版）
kagoshima_100wordsの成功パターンをベースに、必要最小限の指示のみに絞る
"""

from string import Template

# 7ジャンル定義（themeの固定語）
TRANSLATION_GENRES = [
    "研究紹介",  # Research summary
    "時事",      # News / whistleblowing
    "学術",      # Academic exposition
    "ブログ",    # Casual blog post
    "レビュー",  # Review
    "コラム",    # Op-ed / short argument
    "図表",      # Graph / data description
]

# 過去問例（段落分け済み）※スタイル参照用
PAST_QUESTIONS_REFERENCE = """
【2025 研究紹介】段落例
P1: ある研究によると、右手を握りしめることで記憶が良くなり、左手を握りしめることで思い出す能力が高まることが明らかになった。
P2: 参加者は4つのグループに分けられ、まず72語のリストを記憶し、その後で思い出すという課題を行った。
P3: 1つのグループは右手を握りしめて記憶した。別のグループは左手を握りしめて記憶した。残り2つのグループは左右を入れ替えた。
P4: その結果、記憶時に右手・想起時に左手を握りしめたグループが最も良い成績を収めた。

【2024 時事】段落例
P1: 2009年から2013年までNSAに勤務していたSnowdenが、監視活動の情報を密かに収集していた。
P2: Verizonを経由した通話記録の収集を発見し、これを暴露した。
P3: PRISMというプログラムが、大手IT企業9社へ直接アクセスできる仕組みを持っている可能性がある。
P4: 彼を裏切り者と見る人もいれば、英雄と見る人もおり、意見が対立している。

【2023 学術】段落例
P1: 日記をつけることの精神的・感情的効果はデータで実証されており、専門家も勧めている。
P2: 15〜20分の記録を3〜5回続けることで、トラウマやストレスと折り合いをつけられた人もいる。
P3: がんなどの深刻な病気を抱える人には特に効果があり、専門的な療法として確立されている。

【2022 ブログ】段落例
P1: 待ち時間にスマホを確認するのが習慣になっていたが、次々とタスクが連鎖して増えてしまうので、この習慣を減らしたいと思っていた。
P2: 待ち時間にプチ体操（ストレッチ、足首回し、肩回しなど）を試したところ、無理なく続けられている。
P3: スマホを見る時間が減り、首や目の疲れも軽減された。忙しい人にも試す価値があると思う。

【2021 レビュー】段落例
P1: 主人公ジョンの仕事は、孤独死した人の身元を調査し、葬儀を執り行うことだった。
P2: 彼の丁寧な仕事ぶりに胸を打たれた。主人公の表情が心地よかった。
P3: 人と向き合う難しさや大切さを描いたヒューマンドラマで、印象的なラストシーンがある。
P4: 荒んだ心を浄化してくれるような作品で、人を許すことを教えてくれる気がした。
"""

# 問題生成・模範解答用プロンプト（元のものをそのまま使う）
QUESTION_PROMPT_MIYAZAKI_TRANSLATION = """
（問題生成は元のprompts_translation.pyから使う - 今回は添削のみ簡潔化）
"""

MODEL_ANSWER_PROMPT_MIYAZAKI_TRANSLATION = """
（模範解答生成は元のprompts_translation.pyから使う - 今回は添削のみ簡潔化）
"""

CORRECTION_PROMPT_MIYAZAKI_TRANSLATION = """
あなたは宮崎大学医学部の和文英訳問題の添削専門家です。

🚨🚨🚨【JSON出力の絶対ルール】🚨🚨🚨
1. **日本語の引用符「」『』は絶対に使わない** → 代わりに () を使う
2. **例文では半角引用符 " " を使うが、必ずエスケープする** → \\"
3. **JSON内で改行する場合は \\n を使う**
4. **reasonフィールド内では、例文を書く場合は必ず半角スペースで区切る**

❌ NG例（JSON構文エラーになる）:
"reason": "例：This is important.「これは重要です。」"
→ 日本語引用符「」がJSON構文エラーを引き起こす

✅ OK例（正しいJSON）:
"reason": "例：This is important. (これは重要です。)"
→ 丸括弧 () を使う

# 問題形式
和文英訳問題（100-120語目安）
- 日本語原文を英語に訳す
- 医学部レベルの正確性と流暢性が求められる

# 日本語原文
$question_text

# 学生の回答（語数：$word_count語）
$user_answer

# 添削方針【重要】

## ステップ1：提出内容が有効かチェックする

**【🚨最優先チェック🚨】添削を開始する前に必ず確認すること**

1. **学生の回答が英語として意味をなしているか？**
   - 意味不明な文字列（例：asdfghjkl、zzz xxx yyy）
   - 日本語のみ
   - 単語の羅列だけで文になっていない
   - 同じ文の繰り返し（例：Knowledge accumulates over time を4回繰り返しただけ）

2. **学生の英文は、日本語原文を翻訳しようとしたものか？**
   - 日本語原文と全く関係ない内容

3. **日本語原文の全ての内容を英訳しているか？**
   - 一部の段落や文が抜けていないか

🚨🚨🚨【絶対厳守】上記の問題がある場合でも、必ずステップ2の添削を実施すること🚨🚨🚨
**【評価方針】内容に問題があっても、提出された英文は全て評価する**
- 意味不明な文字列でも、文法的な観点から評価する
- 同じ文の繰り返しでも、その文自体の正しさは評価する
- 内容の問題は、points[0]で全体評価として指摘する
- **「添削しない」という選択肢は存在しない**

---

## ステップ2：詳細添削を実施する（必ず実行）

🚨🚨🚨【絶対厳守】提出された英文は必ず全て評価すること🚨🚨🚨
- たとえ日本語原文の一部が抜けていても、提出された部分は全て添削する
- たとえ意味不明な文字列でも、文法的な観点から評価する
- たとえ同じ文の繰り返しでも、その文の文法・表現を評価する
- **「内容が不完全だから添削しない」「意味不明だから添削しない」は絶対NG**
- **どんな入力でも必ず1つ以上のpointを作成すること**

**【🚨最重要🚨】必ず$required_points個の解説項目を作成すること**

原文は$required_points文あります。必ず$required_points個の非「内容評価」pointを返してください。

### 基本的な添削の流れ

1. 学生の英文を文単位で分解する（ピリオドで区切る）
2. 各英文について評価する：
   - 同じ文の繰り返しの場合：最初の1文を評価し、「同じ文が繰り返されています」と指摘
   - 意味不明な文字列の場合：「英文として意味をなしていません」と指摘
   - 通常の文の場合：文法・表現を評価

### 判断順序【必須】

以下の順番で判断し、該当するものがあればそこで判定を確定する：

1. **🚨最優先：beforeとafterが完全に同一かチェック🚨**
   - 同一なら → ✅正しい表現
   - 異なるなら → 次のステップへ

2. **🚨🚨🚨 明確な文法ミス（最優先・必ず検出）🚨🚨🚨** → ❌文法ミス
   
   **【不完全な文】** - 絶対に❌にすること：
   - 文末が接続詞で終わっている：
     ❌ "I like apples and" → 「and」の後に文が続かない
     ❌ "eight hours and Afterward" → 「and」の後に文が続くべき
   - 文末が前置詞で終わっている（形式的な場合を除く）
   
   **【句読点の誤り】** - 絶対に❌にすること：
   - ピリオドの後に小文字の接続詞：
     ❌ "highest scores. while the group" → ピリオドの後に小文字の「while」
     ❌ "important point. and then" → ピリオドの後に小文字の「and」
   - カンマの代わりにピリオド：
     ❌ "As a trial. I started" → ピリオドの代わりにカンマが必要
   
   **【主語と動詞の不一致（三単現）】** - 絶対に❌にすること：
   - "He go" → "He goes"
   - "boundary tend" → "boundary tends" または "boundaries tend"
   
   **【時制の誤り】** - 絶対に❌にすること：
   - "Yesterday, I go" → "Yesterday, I went"
   
   **【冠詞の明確な誤り】** - 絶対に❌にすること：
   - "I am student" → "I am a student"

3. **日本語原文の内容が正確に伝わっていない** → ❌意味不一致
   例：
   - 日本語「毎日」→ 英語「sometimes」（頻度が違う）
   - 日本語「増加した」→ 英語「decreased」（逆の意味）
   - 日本語「3つの理由」→ 英語「two reasons」（数が違う）

4. **明確なコロケーションミス** → ❌誤用
   例：
   - "make a mistake" を "do a mistake" と書いた場合
   - "take a shower" を "make a shower" と書いた場合

5. **それ以外（beforeとafterが異なるが文法ミスではない）** → ✅正しい表現として扱う
   - **重要：この場合、afterをbeforeと同一にすること**
   - 語彙選択の好み、構文の選択肢、文体の違い → 全て✅
   - beforeが正しければ、afterも同じ内容にする

**🚨🚨🚨絶対厳守🚨🚨🚨**
- **✅正しい表現の場合、beforeとafterは完全に同一にすること**
- **語彙や構文の好みの違いは、全て✅として扱う**
- **💡改善提案は絶対に出さない**

### 【出力ラベルは2種類のみ - 💡改善提案は完全廃止】

- **✅ 正しい表現**: 文法的に正しい、意味が通る → beforeとafterは完全に同一
- **❌ 文法ミス / 意味不一致 / 誤用**: 減点レベルの明確な誤りのみ

🚨🚨🚨【絶対厳守】💡改善提案は一切出さない！🚨🚨🚨
- 「より良い表現がある」は ✅ として扱う（after=before）
- 好みや文体の違いは ✅ として扱う（after=before）
- 減点されない表現は全て ✅

### level_typeの分類（❌を出す場合のみ必須）

❌を出す場合は、以下から選ぶ：
- "grammar_error" : 文法の誤り
- "semantic_mismatch" : 意味の不一致
- "collocation_error" : コロケーションミス

### reasonの記述フォーマット【必須・厳守】- kagoshima風テンプレート

🚨🚨🚨【reason は以下の形式で必ず記述すること】🚨🚨🚨

**必須形式（kagoshima風・5点セット）:**
```
N文目: [英文そのまま]
（[日本語訳]）
[語A]（品詞：意味：文脈）／[語B]（品詞：意味：文脈）で、[違いの詳細説明]。
【参考】[文法パターンA]／[文法パターンB]
例：[例文1] ([和訳1])／[例文2] ([和訳2])
```

**絶対厳守:**
1. 英文の後に必ず（日本語訳）を括弧内に記載
2. 語彙比較は必ずA／B形式で2つ以上
3. 【参考】セクションは必須（文法・語法パターンを提示）
4. 例文は必ず2つ、和訳は丸括弧()で囲む（日本語引用符「」は使わない）
5. 例文は学生の英文と異なる新しい例を提示（同一文の繰り返し禁止）

**出力例1（a number of / the number of）:**
```
"reason": "1文目: A number of students submitted the form online.\\n（多くの学生がその用紙をオンラインで提出した。）\\na number of（名詞句：多くの～）／the number of（名詞句：～の数）で、a number of は「たくさん」という量、the number of は「数そのもの」という数量を表します。a number of は後ろが複数名詞なので動詞も複数になりやすい（A number of students are …）。the number of は「数」が主語なので単数扱い（The number of students is …）。\\n【参考】a number of + 複数名詞（多くの～）／the number of + 複数名詞（～の数）\\n例：A number of people were absent. (多くの人が欠席した。)／The number of people was increasing. (人の数が増えていた。)"
```

**出力例2（be likely to / It is likely that）:**
```
"reason": "2文目: She is likely to arrive late because of the traffic.\\n（交通のせいで、彼女は遅れて到着しそうだ。）\\nlikely（形容詞：～しそうだ）／possible（形容詞：あり得る）で、likely は「起こりそう（確率が高め）」、possible は「起こり得る（可能性がある）」という差が出ます。\\n【参考】be likely to do（～しそうだ）／It is likely that S+V（Sが～しそうだ）\\n例：He is likely to win. (彼は勝ちそうだ。)／It is likely that prices will rise. (物価は上がりそうだ。)"
```

**出力例3（due to / because of）:**
```
"reason": "3文目: He succeeded due to his careful planning.\\n（彼は綿密な計画のおかげで成功した。）\\ndue to（前置詞句：～が原因で）／because of（前置詞句：～のために）で、どちらも原因を表しますが、due to はやや硬めで「原因・要因」を述べる文に合いやすい（名詞と相性が良い）一方、because of はより万能で会話でも自然です。\\n【参考】due to A（Aが原因で）／because of A（Aのために）\\n例：The delay was due to the storm. (遅れは嵐が原因だった。)／We stayed home because of the storm. (嵐のため家にいた。)"
```

**🚨🚨🚨 重要：before/afterは必ず完全な1文（全文）🚨🚨🚨**

- beforeは「学生英文の完全な1文」のみ使用（句・節だけは絶対禁止）
  - 例（NG）: "were divide into"
  - 例（OK）: "In the study, the participants were divide into three different groups."
- afterも「完全な1文」にすること
  - ❌ の場合: beforeの全文を修正した完全な1文
  - ✅ の場合: beforeと完全に同一
- 学生が提出していない文を添削する場合のみ、beforeを明示的なプレースホルダにする：
  `before = "(未提出：原文第N文)"`
- その場合afterは模範解答の該当文を置き、reason内で「未提出のため補足」と明記
- プレースホルダ使用例：
```json
{
  "before": "(未提出：原文第4文)",
  "after": "This method helps in converting short-term memory into long-term memory.",
  "reason": "4文目: (未提出のため補足)\\n（この手法は短期記憶を長期記憶に変換するのに役立つ。）\\nconvert（動詞：変換する・変える：形や性質を変える文脈）／transform（動詞：変形させる・一変させる：完全に変える文脈）で、convertは形や性質を変えること、transformは全体を一変させることを指します。\\n【参考】convert A into B（AをBに変換する）／transform A into B（AをBに変形させる）\\n例：We need to convert this data. (このデータを変換する必要があります。)／The city was transformed. (都市は一変しました。)",
  "level": "✅ 補足解説"
}
```

---

## ステップ3：全体評価の決定（添削完了後に実施）

ステップ1で確認した内容に基づいて、全体評価を決定する：

### パターンA：内容不一致がある場合
- points[0]に以下を追加：
```json
{{
  "before": "(全体評価)",
  "after": "(全体評価)",
  "reason": "解説：提出された英文は、日本語原文の内容とは異なります。問題文をよく読んで、日本語原文を正確に英訳してください。",
  "level": "❌ 意味不一致"
}}
```

### パターンB：内容の抜け落ちがある場合
- points[0]に以下を追加：
```json
{{
  "before": "(全体評価)",
  "after": "(全体評価)",
  "reason": "解説：日本語原文の一部が英訳されていません。日本語原文の全ての内容を英訳してください。[具体的に何が抜けているか]",
  "level": "❌ 内容不足"
}}
```

### パターンC：内容一致、通常の添削
- points[0]は作成しない
- points[1]以降に詳細な添削ポイントのみを記載

---

🚨🚨🚨【JSON出力前の最終確認】🚨🚨🚨

1. **points配列は空ではない**（最低1個以上）
2. **全てのreasonは「解説：」で始まっている**
3. **全てのreasonに2つ以上の例が含まれている**
4. **levelは「✅ 正しい表現」または「❌ 文法ミス」「❌ 意味不一致」「❌ 誤用」のみ**
5. **日本語引用符「」『』は使っていない**（丸括弧()を使用）
6. **JSON内の引用符はエスケープされている**（\\"）

---

# 出力フォーマット

**必ず以下のJSON形式で出力してください（それ以外は出力しないこと）：**

```json
{{
  "original": "学生が提出した英文（元のまま）",
  "corrected": "模範解答（100-120語、日本語原文の全内容を含む完全な英訳）",
  "word_count": 語数（数値）,
  "points": [
    {{
      "before": "学生英文の完全な1文（全文・句や節だけは不可）",
      "after": "修正後の完全な1文（❌の場合）OR beforeと同一（✅の場合）",
      "reason": "解説：[説明] 例：[例1] → [正しい例1]、[例2] → [正しい例2]",
      "level": "✅ 正しい表現 OR ❌ 文法ミス / ❌ 意味不一致 / ❌ 誤用",
      "level_type": "grammar_error / semantic_mismatch / collocation_error（❌の場合のみ）",
      "japanese_sentence": "対応する日本語原文（optional）"
    }}
  ]
}}
```

**🚨重要な注意事項：**
- correctedは必ず完全な英訳（100-120語）を含めること
- **pointsは必ず$required_points個含めること**（非「内容評価」の項目）
- 各pointのreasonは上記のkagoshima風5点セット形式を厳守すること
  - N文目: 英文（日本語訳）
  - 語彙比較A／B（品詞・意味・文脈）
  - 【参考】文法パターン
  - 例：例文1 (和訳1)／例文2 (和訳2)
- levelは「✅」または「❌」のみ（💡は使わない）
- $required_points個のpointsが足りない場合は、追加の解説を作成すること
- 例文は学生の英文と異なる新しい例を必ず2つ提示すること
- beforeは学生英文に存在する文字列のみ使用（未提出の場合は "(未提出：原文第N文)" プレースホルダを使用）
"""

# プロンプト辞書のエクスポート
PROMPTS = {
    'correction': CORRECTION_PROMPT_MIYAZAKI_TRANSLATION
}

"""
LLMã‚µãƒ¼ãƒ“ã‚¹ - OpenAI APIå‘¼ã³å‡ºã—ã¨ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
é¹¿å…å³¶å¤§å­¦è‹±ä½œæ–‡ç‰¹è¨“ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç†ç³»ãƒ»æ–‡ç³»ç‰ˆï¼‰
"""
import os
import json
import logging
from typing import Optional, Dict, Any, List
from openai import OpenAI
from pydantic import ValidationError
from models import QuestionResponse, CorrectionResponse, SubmissionRequest, TargetWords, ConstraintChecks
from constraint_validator import validate_constraints as validate_constraints_func
import config

logger = logging.getLogger(__name__)

# OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
client = OpenAI(
    api_key=config.OPENAI_API_KEY,
    timeout=config.OPENAI_TIMEOUT
)


# ===== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰ =====

# é¹¿å…å³¶å¤§å­¦ï¼ˆæ–‡ç³» + åŒ»ãƒ»æ­¯ãƒ»ç£åŒ»ï¼‰å¤§å•ï¼•ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
QUESTION_PROMPT_GENERAL = """
ã‚ãªãŸã¯é¹¿å…å³¶å¤§å­¦ï¼ˆæ–‡ç³» + åŒ»ãƒ»æ­¯ãƒ»ç£åŒ»ï¼‰å¤§å•ï¼•ã®å‡ºé¡Œå°‚é–€å®¶ã§ã™ã€‚

# é¹¿å…å³¶å¤§å­¦ å¤§å•ï¼•ã®ç‰¹å¾´
- è‹±èªã§æ„è¦‹ã‚’è¿°ã¹ã‚‹å½¢å¼ï¼ˆ100-120èªï¼‰
- ã€ŒGive two reasons to support your answerã€ã¾ãŸã¯ã€ŒGive at least two...ã€ã¨ã„ã†æŒ‡ç¤ºãŒå¤šã„
- å€‹äººçš„ãªæ„è¦‹ã‚„çµŒé¨“ã‚’æ±‚ã‚ã‚‹
- å…·ä½“çš„ãªç†ç”±ã‚„èª¬æ˜ã‚’æ±‚ã‚ã‚‹
- ãƒ†ãƒ¼ãƒã¯å¤šå²ã«ã‚ãŸã‚‹ï¼ˆYouTubeã€SNSã€å°é¢¨å¯¾ç­–ã€å¤§å­¦ã®é‡è¦æ€§ã€å‹äººã‚’åŠ±ã¾ã™æ–¹æ³•ã€ç¡çœ ã®è³ªã€äººç”Ÿã®å‡ºæ¥äº‹ã€åœ°ç†ã®é‡è¦æ€§ã€é«˜æ ¡ç”Ÿã®å•é¡Œã€ã‚­ãƒ£ãƒªã‚¢ç›®æ¨™ãªã©ï¼‰

# å‡ºé¡Œæ¡ä»¶
- é›£æ˜“åº¦: {difficulty}
- é¿ã‘ã‚‹ãƒ†ãƒ¼ãƒ: {excluded_themes}

# å‡ºé¡Œãƒ†ãƒ¼ãƒä¾‹ï¼ˆå…¨35ãƒ†ãƒ¼ãƒï¼‰
## æ•™è‚²ãƒ»å­¦ç¿’ãƒ»å¤§å­¦ç”Ÿæ´»
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ•™è‚²ã®åˆ©ç‚¹
- èª­æ›¸ã®åŠ¹æœ
- å›³æ›¸é¤¨ã®å½¹å‰²
- å¤–å›½èªå­¦ç¿’ã®é‡è¦æ€§
- ã‚°ãƒ«ãƒ¼ãƒ—å­¦ç¿’ vs å€‹äººå­¦ç¿’
- å¤§å­¦ã«é€²å­¦ã™ã‚‹ç†ç”±
- ç†æƒ³çš„ãªæ•™å¸«ã®æ¡ä»¶
- å­¦æ ¡ã§ã®ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ä½¿ç”¨

## å¥åº·ãƒ»ã‚¹ãƒãƒ¼ãƒ„ãƒ»ç”Ÿæ´»ç¿’æ…£
- é‹å‹•ç¿’æ…£ã®å¤§åˆ‡ã•
- è‰¯ã„ç¡çœ ã‚’ä¿ƒé€²ã™ã‚‹æ–¹æ³•
- ã‚¹ãƒˆãƒ¬ã‚¹ç®¡ç†ã®æ–¹æ³•
- ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦ã®é­…åŠ›
- å¥åº·çš„ãªé£Ÿç”Ÿæ´»
- æ—©èµ·ãã®ãƒ¡ãƒªãƒƒãƒˆ

## ç’°å¢ƒãƒ»ç¤¾ä¼šå•é¡Œãƒ»ç½å®³å¯¾ç­–
- é£Ÿå“ãƒ­ã‚¹å‰Šæ¸›
- ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯å‰Šæ¸›
- ãƒªã‚µã‚¤ã‚¯ãƒ«ã®é‡è¦æ€§
- å…¬å…±äº¤é€šæ©Ÿé–¢ã®åˆ©ç”¨
- è‡ªç„¶ä¿è­·
- åœ°åŸŸæ´»æ€§åŒ–
- å°é¢¨ã¸ã®å‚™ãˆ
- åœ°éœ‡ã¸ã®å‚™ãˆ

## æ–‡åŒ–ãƒ»è¶£å‘³ãƒ»å¨¯æ¥½ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢
- æ—…è¡Œã®æ„ç¾©
- éŸ³æ¥½ã®å½¹å‰²
- æ˜ ç”»é‘‘è³ã®æ¥½ã—ã¿
- ä¼çµ±æ–‡åŒ–ã®ç¶™æ‰¿
- ãƒšãƒƒãƒˆã¨ã®ç”Ÿæ´»
- è¶£å‘³ã®é‡è¦æ€§
- YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã®ã‚¢ã‚¤ãƒ‡ã‚¢
- å¥½ããªå­£ç¯€ã¨ãã®ç†ç”±

## ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢ãƒ»å°†æ¥ã®å¤¢
- ç†æƒ³ã®è·æ¥­
- é€±ä¼‘3æ—¥åˆ¶ã®æ˜¯é
- ã‚¢ãƒ«ãƒã‚¤ãƒˆã®çµŒé¨“
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚·ãƒƒãƒ—ã®ä¾¡å€¤
- ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ¡ãƒªãƒƒãƒˆ
- ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹
- ã‚­ãƒ£ãƒªã‚¢ç›®æ¨™ã¨å¿…è¦ãªã“ã¨

## ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»SNS
- SNSã§ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  vs æœ¬å
- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®å½±éŸ¿
- AIæŠ€è¡“ã®ç™ºå±•
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹æ±ºæ¸ˆ
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°

## ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»äººé–“é–¢ä¿‚
- å‹äººã‚’åŠ±ã¾ã™æ–¹æ³•
- ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•
- ä¸–ä»£é–“äº¤æµ
- ç•°æ–‡åŒ–ç†è§£
- ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›
- ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã®é‡è¦æ€§

## é«˜æ ¡ç”Ÿæ´»ãƒ»å­¦ç”Ÿç”Ÿæ´»
- é«˜æ ¡ç”ŸãŒæŠ±ãˆã‚‹å…¸å‹çš„ãªå•é¡Œã¨è§£æ±ºç­–
- éƒ¨æ´»å‹•ã®æ„ç¾©
- è©¦é¨“å‹‰å¼·ã®æ–¹æ³•
- æ™‚é–“ç®¡ç†ã®é‡è¦æ€§

## åœ°ç†ãƒ»æ­´å²ãƒ»ç¤¾ä¼š
- åœ°ç†ã‚’å­¦ã¶é‡è¦æ€§
- æ­´å²ã‚’å­¦ã¶æ„ç¾©
- ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã“ã¨ã®é‡è¦æ€§

## äººç”Ÿãƒ»ä¾¡å€¤è¦³ãƒ»æ€ã„å‡º
- äººç”Ÿã«ãŠã‘ã‚‹é‡è¦ãªä¾¡å€¤è¦³
- éå»æ•°å¹´ã§èµ·ããŸãƒã‚¸ãƒ†ã‚£ãƒ–ãªå‡ºæ¥äº‹
- å°Šæ•¬ã™ã‚‹äººç‰©ã¨ãã®ç†ç”±
- å¹¸ç¦ã¨ã¯ä½•ã‹

# ç”Ÿæˆç‰©
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
{{
  "theme": "ãƒ†ãƒ¼ãƒåï¼ˆæ—¥æœ¬èªï¼‰",
  "question_text": "è‹±èªã®å•é¡Œæ–‡ï¼ˆ100-120èªã§æ„è¦‹ã‚’è¿°ã¹ã‚‹å½¢å¼ï¼‰",
  "hints": [
    {{"en": "å‹•è©1ï¼ˆå˜èªã¾ãŸã¯ç†Ÿèªï¼‰", "ja": "æ—¥æœ¬èªè¨³", "kana": "ã‹ãª", "pos": "å‹•è©", "usage": "promote Aã€ŒAã‚’ä¿ƒé€²ã™ã‚‹ã€"}},
    {{"en": "å‹•è©2ï¼ˆå˜èªã¾ãŸã¯ç†Ÿèªï¼‰", "ja": "æ—¥æœ¬èªè¨³", "kana": "ã‹ãª", "pos": "å‹•è©", "usage": "contribute to Aã€ŒAã«è²¢çŒ®ã™ã‚‹ã€"}},
    {{"en": "åè©", "ja": "æ—¥æœ¬èªè¨³", "kana": "ã‹ãª", "pos": "åè©"}},
    {{"en": "å½¢å®¹è©", "ja": "æ—¥æœ¬èªè¨³", "kana": "ã‹ãª", "pos": "å½¢å®¹è©"}},
    {{"en": "åè©", "ja": "æ—¥æœ¬èªè¨³", "kana": "ã‹ãª", "pos": "åè©"}}
  ],
  "target_words": {{"min": 100, "max": 120}},
  "model_answer": "æ¨¡ç¯„è§£ç­”ã®è‹±æ–‡ï¼ˆ100-120èªï¼‰",
  "alternative_answer": "åˆ¥è§£ã®è‹±æ–‡ï¼ˆç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€100-120èªï¼‰",
  "common_mistakes": [
    "ã‚ˆãã‚ã‚‹ãƒŸã‚¹1ï¼ˆä¾‹ï¼šç†ç”±ãŒ1ã¤ã—ã‹æ›¸ã‘ã¦ã„ãªã„ï¼‰",
    "ã‚ˆãã‚ã‚‹ãƒŸã‚¹2ï¼ˆä¾‹ï¼šèªæ•°ãŒè¶³ã‚Šãªã„ï¼‰",
    "ã‚ˆãã‚ã‚‹ãƒŸã‚¹3ï¼ˆä¾‹ï¼šè³ªå•ã«ç­”ãˆã¦ã„ãªã„ï¼‰"
  ]
}}

å•é¡Œæ–‡ã®å½¢å¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š
1. "Imagine that you... What would... Give two reasons to support your answer."
2. "Do you think that... Give two reasons to support your answer."
3. "What should you do to... Give at least two things you need to do and why."
4. "Why do you think it important to... Give at least two reasons."
5. "When..., how do you... Describe two things you would do and why."
6. "What do you think would... Give at least two examples with specific explanations."
7. "What have been two... in your life over the past few years?"
8. "Why is it important to... Explain your view and give two reasons to support it."
9. "Write about... Offer two suggestions for how to overcome this problem."
10. "What is your..., and what are two things you must do to achieve this?"

ãƒ’ãƒ³ãƒˆå˜èªã®ç”Ÿæˆãƒ«ãƒ¼ãƒ«ã€é‡è¦ã€‘ï¼š
1. **ã€æœ€é‡è¦ã€‘å•é¡Œæ–‡ã®ãƒ†ãƒ¼ãƒã«é–¢é€£ã™ã‚‹å˜èªãƒ»è¡¨ç¾ã®ã¿ã‚’é¸ã¶ã“ã¨**
   - ãƒ†ãƒ¼ãƒã«åˆã£ãŸèªå½™ã‚’é¸ã¶ï¼ˆYouTubeãªã‚‰content, subscriber, upload ãªã©ï¼‰
   - å›ç­”ã‚’æ›¸ãã¨ãã«å®Ÿéš›ã«ä½¿ã†å¯èƒ½æ€§ãŒé«˜ã„å˜èªã‚’é¸ã¶

2. **å¿…ãšå‹•è©ã‚’2å€‹å«ã‚ã‚‹**ï¼ˆæœ€åˆã®2ã¤ã¯å¿…ãšå‹•è©ã¾ãŸã¯ç†Ÿèªï¼‰
   - ãƒ†ãƒ¼ãƒã«é–¢é€£ã™ã‚‹å‹•ä½œã‚’è¡¨ã™å‹•è©ã‚’é¸ã¶
   - å˜èªå‹•è©ï¼špromote, contribute, achieve, overcome, prepare, encourage, reduce, improve
   - ç†Ÿèªå‹•è©ï¼šdeal with, focus on, contribute to, take part in, cheer up

3. **å‹•è©ã«ã¯å¿…ãšç”¨æ³•ï¼ˆusageï¼‰ã‚’è¨˜è¼‰**
   - å˜èªå‹•è©ï¼špromote Aã€ŒAã‚’ä¿ƒé€²ã™ã‚‹ã€ã€achieve Aã€ŒAã‚’é”æˆã™ã‚‹ã€
   - ç†Ÿèªï¼šdeal with Aã€ŒAã«å¯¾å‡¦ã™ã‚‹ã€ã€focus on Aã€ŒAã«é›†ä¸­ã™ã‚‹ã€

4. **æ®‹ã‚Š3ã¤ã¯åè©ãƒ»å½¢å®¹è©ãªã©ã§ã€å¿…ãšå“è©ï¼ˆposï¼‰ã‚’è¨˜è¼‰**
   - ãƒ†ãƒ¼ãƒã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãªã‚‹åè©ãƒ»å½¢å®¹è©ã‚’é¸ã¶

5. **ä¸­å­¦1ã€œ2å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬å˜èªã¯é¿ã‘ã‚‹**
   - NGä¾‹ï¼šgo, come, have, make, get, see, know, think
   - OKä¾‹ï¼špromote, contribute, achieve, overcome, prepare, encourage

é‡è¦ãªåˆ¶ç´„ï¼š
1. å¿…ãšJSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„
2. Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ```jsonï¼‰ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. èª¬æ˜æ–‡ã‚„è¿½åŠ ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„
4. ã™ã¹ã¦ã®ã‚­ãƒ¼ã¯å¿…é ˆã§ã™ï¼ˆnullã¯ç¦æ­¢ï¼‰
5. question_textã¯å¿…ãšè‹±èªã§è¨˜è¿°ã—ã¦ãã ã•ã„
6. æ¨¡ç¯„è§£ç­”ã¨åˆ¥è§£ã¯å¿…ãš100-120èªã§è¨˜è¿°ã—ã¦ãã ã•ã„
"""


CORRECTION_PROMPT_TEMPLATE = """
ã‚ãªãŸã¯é¹¿å…å³¶å¤§å­¦ï¼ˆæ–‡ç³» + åŒ»ãƒ»æ­¯ãƒ»ç£åŒ»ï¼‰å¤§å•ï¼•ã®è‹±ä½œæ–‡æ·»å‰Šå°‚é–€å®¶ã§ã™ã€‚

# å•é¡Œæ–‡ï¼ˆè‹±èªï¼‰
{japanese_text}

# å­¦ç”Ÿã®å›ç­”
{user_answer}

# æ·»å‰Šæ–¹é‡ã€é‡è¦ã€‘
- **å¤§å•ï¼•ã¯æ„è¦‹è«–è¿°å½¢å¼ã§ã™**
- **å­¦ç”Ÿã®å›ç­”ã‚’ãƒ”ãƒªã‚ªãƒ‰ï¼ˆ.ï¼‰ã€ç–‘å•ç¬¦ï¼ˆ?ï¼‰ã€æ„Ÿå˜†ç¬¦ï¼ˆ!ï¼‰ã§æ–‡ã«åˆ†å‰²ã—ã€å„æ–‡ã«å¯¾ã—ã¦1ã¤ãšã¤è§£èª¬ã‚’ä½œæˆã™ã‚‹ã“ã¨**
- **pointsã®æ•°ã¯ã€å­¦ç”ŸãŒæå‡ºã—ãŸæ–‡ã®æ•°ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹ã“ã¨**

## æ·»å‰Šã®æµã‚Œ
1. **å•é¡Œæ–‡ã®è¶£æ—¨ã«åˆã£ã¦ã„ã‚‹ã‹è©•ä¾¡**ï¼ˆæœ€åˆã®pointã§å¿…ãšè©•ä¾¡ã™ã‚‹ï¼‰
2. **å­¦ç”Ÿã®å›ç­”ã‚’æ–‡ã”ã¨ã«åˆ†å‰²**ï¼ˆãƒ”ãƒªã‚ªãƒ‰ã€ç–‘å•ç¬¦ã€æ„Ÿå˜†ç¬¦ã§åŒºåˆ‡ã‚‹ï¼‰
3. **å„æ–‡ã«å¯¾ã—ã¦1ã¤ãšã¤è§£èª¬ã‚’ä½œæˆ**ï¼ˆæ–‡æ³•ãƒ»èªå½™ãƒ»è¡¨ç¾ã«ã¤ã„ã¦ï¼‰

## æœ€åˆã®pointï¼ˆå•é¡Œæ–‡ã®è¶£æ—¨è©•ä¾¡ï¼‰
- **before**: "âœ… å•é¡Œæ–‡ã®è¶£æ—¨ã«åˆã£ã¦ã„ã¾ã™" ã¾ãŸã¯ "âŒ å•é¡Œæ–‡ã®è¶£æ—¨ã¨ç•°ãªã‚Šã¾ã™"
- **after**: ï¼ˆåŒã˜ï¼‰
- **reason**: å•é¡Œæ–‡ã®æŒ‡ç¤ºï¼ˆã€ŒGive two reasonsã€ãªã©ï¼‰ã«å¾“ã£ã¦ã„ã‚‹ã‹ã€ãƒ†ãƒ¼ãƒã«æ²¿ã£ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡
- **level**: "è¶£æ—¨è©•ä¾¡"

## å„æ–‡ã®è§£èª¬point
- **before**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›¸ã„ãŸæ–‡ï¼ˆãã®ã¾ã¾ï¼‰
- **after**: æ–‡æ³•ãƒŸã‚¹ã®ã¿ã‚’ä¿®æ­£ã—ãŸæ–‡ï¼ˆèª¤ã‚ŠãŒãªã‘ã‚Œã°beforeã¨åŒã˜ï¼‰
- **reason**: èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦ã€ã€Œèªå½™Aï¼ˆç”¨æ³•ï¼‰ï¼èªå½™Bï¼ˆç”¨æ³•ï¼‰ã€å½¢å¼ã§è§£èª¬
- **level**: "âœ… æ­£ã—ã„èªå½™é¸æŠã§ã™" / "âŒ æ–‡æ³•ãƒŸã‚¹" / "ğŸ’¡ æ”¹å–„ææ¡ˆ" ãªã©

- **ä¿®æ­£ç‰ˆï¼ˆcorrectedï¼‰ã¯ã€å­¦ç”Ÿã®å›ç­”ã®æ–‡æ³•ãƒŸã‚¹ã®ã¿ã‚’ä¿®æ­£ã—ãŸã‚‚ã®**ï¼ˆæ–‡ã®é †åºã‚„å†…å®¹ã¯å¤‰ãˆãªã„ï¼‰
- ä¿®æ­£å¯¾è±¡ï¼š**æ–‡æ³•ãƒŸã‚¹ã€ã‚¹ãƒšãƒ«ãƒŸã‚¹ã€èªé †ã®èª¤ã‚Šã€å¥èª­ç‚¹ãƒŸã‚¹ã€å‰ç½®è©ã®èª¤ã‚Šã€å† è©ã®èª¤ã‚Šã®ã¿**
- ä¿®æ­£å¯¾è±¡å¤–ï¼šå˜ãªã‚‹è¨€ã„æ›ãˆã€ã‚ˆã‚Šè‰¯ã„è¡¨ç¾ã¸ã®å¤‰æ›´ï¼ˆã“ã‚Œã‚‰ã¯è§£èª¬ã§è§¦ã‚Œã‚‹ã®ã¿ï¼‰

# ã€æœ€é‡è¦ã€‘3ç¨®é¡ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¨˜å·ã®å³å¯†ãªä½¿ã„åˆ†ã‘ãƒ«ãƒ¼ãƒ«

## âŒï¼ˆæ˜ç¢ºãªèª¤ã‚Šï¼‰
- **æ¡ä»¶ï¼šbefore â‰  after ã‹ã¤ æ–‡æ³•çš„ãªèª¤ã‚Š**
- ä¾‹ï¼š`by anyone â†’ for it`ï¼ˆå‰ç½®è©ãƒŸã‚¹ï¼‰ã€`travel â†’ traveling`ï¼ˆå‹•åè©ãŒå¿…è¦ï¼‰

## ğŸ’¡ï¼ˆæ”¹å–„ææ¡ˆï¼‰
- **æ¡ä»¶ï¼šbefore â‰  after ã‹ã¤ æ–‡æ³•çš„ã«ã¯æ­£ã—ã„ãŒã€ã‚ˆã‚Šè‡ªç„¶/é©åˆ‡ãªè¡¨ç¾ãŒã‚ã‚‹**
- ä¾‹ï¼š`viewing films â†’ watching movies`ï¼ˆviewing ã¯æ­£ã—ã„ãŒ watching ã®æ–¹ãŒè‡ªç„¶ï¼‰

## âœ…ï¼ˆæ­£ã—ã„è¡¨ç¾ï¼‰
- **æ¡ä»¶ï¼šbefore = after ã§å®Œç’§**
- ä¾‹ï¼š`health â†’ health`ï¼ˆå®Œç’§ãªèªå½™é¸æŠï¼‰

# å‡ºåŠ›JSON
{{
  "original": "{user_answer}",
  "corrected": "å­¦ç”Ÿã®å›ç­”ã®æ–‡æ³•ãƒŸã‚¹ã®ã¿ã‚’ä¿®æ­£ã—ãŸã‚‚ã®ï¼ˆæ–‡ã®é †åºã‚„å†…å®¹ã¯å¤‰ãˆãªã„ï¼‰",
  "word_count": XX,
  "points": [
    {{
      "before": "âœ… å•é¡Œæ–‡ã®è¶£æ—¨ã«åˆã£ã¦ã„ã¾ã™",
      "after": "âœ… å•é¡Œæ–‡ã®è¶£æ—¨ã«åˆã£ã¦ã„ã¾ã™",
      "reason": "å•é¡Œæ–‡ã®è¶£æ—¨è©•ä¾¡\nè§£èª¬ï¼šå•é¡Œæ–‡ã¯ã€Œ{japanese_text}ã€ã§ã™ã€‚æå‡ºã•ã‚ŒãŸè‹±æ–‡ã¯ã€ã“ã®å•ã„ã«å¯¾ã—ã¦é©åˆ‡ã«ç­”ãˆã¦ã„ã¾ã™ã€‚ã€ŒGive two reasonsã€ã¨ã„ã†æŒ‡ç¤ºã«ã‚‚å¾“ã£ã¦ãŠã‚Šã€2ã¤ã®ç†ç”±ãŒæ˜ç¢ºã«è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚èªæ•°ã‚‚é©åˆ‡ã§ã™ï¼ˆXXèªï¼‰ã€‚",
      "level": "è¶£æ—¨è©•ä¾¡"
    }},
    {{
      "before": "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®1æ–‡ç›®ï¼‰",
      "after": "ï¼ˆä¿®æ­£ã—ãŸ1æ–‡ç›®ã€èª¤ã‚ŠãŒãªã‘ã‚Œã°beforeã¨åŒã˜ï¼‰",
      "reason": "èªå½™/ç†Ÿèªã«ã¤ã„ã¦ï¼ˆâœ… æ­£ã—ã„èªå½™é¸æŠã§ã™ / âŒ æ–‡æ³•ãƒŸã‚¹ / ğŸ’¡ æ”¹å–„ææ¡ˆï¼‰\nè§£èª¬ï¼šã€Œèªå½™Aï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ï¼èªå½™Bï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ã€ã®å½¢å¼ã§è©³ç´°ãªä½¿ã„åˆ†ã‘ã¨ã€å…·ä½“ä¾‹ãƒ»ä¾‹æ–‡ã‚’å«ã‚€æ—¥æœ¬èªè§£èª¬",
      "level": "æ­£ã—ã„èªå½™é¸æŠã§ã™"
    }},
    {{
      "before": "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®2æ–‡ç›®ï¼‰",
      "after": "ï¼ˆä¿®æ­£ã—ãŸ2æ–‡ç›®ï¼‰",
      "reason": "2æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®3æ–‡ç›®ï¼‰",
      "after": "ï¼ˆä¿®æ­£ã—ãŸ3æ–‡ç›®ï¼‰",
      "reason": "3æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    ... ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæå‡ºã—ãŸæ–‡ã®æ•°ã ã‘ç¶šãï¼‰
  ]
}}

é‡è¦ãªåˆ¶ç´„:
1. å¿…ãšJSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„
2. Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ```jsonï¼‰ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. originalã¯ãã®ã¾ã¾ã€correctedã¯æ–‡æ³•ãƒŸã‚¹ã®ã¿ã‚’ä¿®æ­£ï¼ˆå†…å®¹ã‚„é †åºã¯å¤‰ãˆãªã„ï¼‰
4. **ã€çµ¶å¯¾å³å®ˆã€‘pointsã¯å¿…ãšã€Œè¶£æ—¨è©•ä¾¡ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæå‡ºã—ãŸæ–‡ã®æ•°ã€ã¨åŒã˜å€‹æ•°ã‚’ä½œæˆã™ã‚‹ã“ã¨**
   - ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ8æ–‡æå‡ºã—ãŸå ´åˆ â†’ 9å€‹ã®pointsï¼ˆ1å€‹ç›®ï¼šè¶£æ—¨è©•ä¾¡ã€2-9å€‹ç›®ï¼šå„æ–‡ã®è§£èª¬ï¼‰
5. reasonã«ã¯å¿…ãšã€Œèªå½™/ç†Ÿèªã«ã¤ã„ã¦ï¼ˆæ­£ã—ã„èªå½™é¸æŠã§ã™/æ­£ã—ã„è¡¨ç¾ã§ã™ï¼‰ã€ã®ã‚ˆã†ãªè¦‹å‡ºã—ã¨ã€ã€Œèªå½™Aï¼ˆç”¨æ³•ï¼‰ï¼èªå½™Bï¼ˆç”¨æ³•ï¼‰ã€å½¢å¼ã®è©³ç´°ãªä½¿ã„åˆ†ã‘è§£èª¬ãƒ»ä¾‹æ–‡ã‚’å«ã‚ã‚‹ã“ã¨
6. è§£èª¬ã¯å¿…ãšæ—¥æœ¬èªã®ã¿ã§è¨˜è¼‰

æ·»å‰Šã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³:
- ä¿®æ­£ç®‡æ‰€ï¼ˆâŒï¼‰ãŒã‚ã‚‹å ´åˆã¯ã€æ–‡æ³•ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚’æ˜ç¢ºã«è§£èª¬ã™ã‚‹ã“ã¨
- æ”¹å–„ææ¡ˆï¼ˆğŸ’¡ï¼‰ã®å ´åˆã¯ã€å…ƒã®è¡¨ç¾ãŒæ–‡æ³•çš„ã«æ­£ã—ã„ã“ã¨ã‚’èªã‚ãŸä¸Šã§ã€ã‚ˆã‚Šè‡ªç„¶ãªè¡¨ç¾ã‚’ææ¡ˆã™ã‚‹ã“ã¨
- ãƒ”ãƒªã‚ªãƒ‰ãƒ»ã‚«ãƒ³ãƒãªã©ã®å¥èª­ç‚¹ãƒŸã‚¹ã‚’æŒ‡æ‘˜ã™ã‚‹å ´åˆã§ã‚‚ã€ãã®æ–‡ã®èªå½™ã«ã¤ã„ã¦å¿…ãšè§£èª¬ã™ã‚‹ã“ã¨
- èªå½™é¸æŠãŒæ­£ã—ã„å ´åˆã‚‚ã€Œæ­£ã—ã„èªå½™é¸æŠã§ã™ã€ã¨æ˜ç¤ºã—ã€é¡ä¼¼èªã¨ã®è©³ç´°ãªä½¿ã„åˆ†ã‘ã‚’è§£èª¬ã™ã‚‹ã“ã¨
- è§£èª¬ã«ã¯å¿…ãšã€Œèªå½™Aï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼‰ï¼èªå½™Bï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼‰ã€ã®å½¢å¼ã§ä½¿ã„åˆ†ã‘ã‚’ç¤ºã—ã€å…·ä½“ä¾‹ã‚’å«ã‚ã‚‹ã“ã¨
- è§£èª¬ã¯å¿…ãšæ—¥æœ¬èªã®ã¿ã§è¨˜è¼‰
"""

ã€ŒSo ã«ã¤ã„ã¦ï¼ˆæ­£ã—ã„æ¥ç¶šè©ã§ã™ï¼‰
ã€ŒSo ã«ã¤ã„ã¦ï¼ˆâœ… æ­£ã—ã„æ¥ç¶šè©ã§ã™ï¼‰
è§£èª¬ï¼šSo ã¯å£èªçš„æ–‡è„ˆã§ã¯æ­£ã—ã„æ¥ç¶šè©ã§ã™ã€‚Soï¼ˆã ã‹ã‚‰ï¼šå‹äººã‚„å®¶æ—ã¨ã®æ—¥å¸¸ä¼šè©±ã§ã®å› æœé–¢ä¿‚ï¼‰ï¼Thereforeï¼ˆå¾“ã£ã¦ï¼šãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ãƒ»è«–æ–‡ã§ã®ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªè«–ç†çš„å¸°çµï¼‰ï¼Thusï¼ˆã‚ˆã£ã¦ï¼šå­¦è¡“è«–æ–‡ãƒ»æ³•å¾‹æ–‡æ›¸ã§ã®æ”¹ã¾ã£ãŸå› æœé–¢ä¿‚ï¼‰ã§ã€ä»Šå›ã¯æ—¥å¸¸ä¼šè©±ãªã®ã§ So ãŒè‡ªç„¶ã§ã™ã€‚ä¾‹ï¼šI'm tired. So I'll go to bed early.ï¼ˆç–²ã‚ŒãŸã€‚ã ã‹ã‚‰æ—©ãå¯ã‚‹ã€‚ï¼‰ã€

ã€Œbad ã«ã¤ã„ã¦ï¼ˆğŸ’¡ ã‚ˆã‚Šè‰¯ã„è¡¨ç¾ã®ææ¡ˆï¼‰
è§£èª¬ï¼šbad ã¯æ–‡æ³•çš„ã«æ­£ã—ã„ã§ã™ãŒã€ã‚ˆã‚Šã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯ãªè¡¨ç¾ãŒã‚ã‚Šã¾ã™ã€‚badï¼ˆæ‚ªã„ï¼šæ—¥å¸¸ä¼šè©±ã§ã®ä¸€èˆ¬çš„ãªå¦å®šçš„è©•ä¾¡ï¼‰ï¼negatively impactsï¼ˆæ‚ªå½±éŸ¿ã‚’åŠã¼ã™ï¼šå­¦è¡“è«–æ–‡ãƒ»ãƒ¬ãƒãƒ¼ãƒˆã§ã®ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªè¡¨ç¾ï¼‰ã§ã€ä»Šå›ã®æ–‡è„ˆã§ã¯ bad ã§æ„å‘³ã¯é€šã˜ã¾ã™ãŒã€å…¥è©¦ã‚„ãƒ¬ãƒãƒ¼ãƒˆã§ã¯ negatively impacts ã®æ–¹ãŒå¥½å°è±¡ã§ã™ã€‚ä¾‹ï¼šSmoking is bad for health.ï¼ˆå–«ç…™ã¯å¥åº·ã«æ‚ªã„ã€‚ï¼‰Smoking negatively impacts public health.ï¼ˆå–«ç…™ã¯å…¬è¡†è¡›ç”Ÿã«æ‚ªå½±éŸ¿ã‚’åŠã¼ã™ã€‚ï¼‰ã€

ã€Œuse up ã«ã¤ã„ã¦ï¼ˆâœ… æ­£ã—ã„ç†Ÿèªé¸æŠã§ã™ï¼‰
è§£èª¬ï¼šuse up ã¯æ­£ã—ã„ã§ã™ãŒã€ã€Œä½¿ã„åˆ‡ã‚‹ã€ã‚’è¡¨ã™ç†Ÿèªã®ä½¿ã„åˆ†ã‘ãŒé‡è¦ã§ã™ã€‚use upï¼ˆå…¨éƒ¨ä½¿ã£ã¦ãªããªã‚‹ï¼šé£Ÿã¹ç‰©ãƒ»ææ–™ã‚’ä½¿ã„åˆ‡ã‚‹å ´é¢ï¼‰ï¼run out ofï¼ˆåœ¨åº«ãŒãªããªã‚‹ï¼šç¶™ç¶šçš„ã«ä½¿ã£ã¦ã„ãŸã‚‚ã®ã®ä¾›çµ¦ãŒå°½ãã‚‹å ´é¢ï¼‰ã§ã€ä»Šå›ã¯è²·ã£ãŸé£Ÿæã‚’ä½¿ã„åˆ‡ã‚Œãªã„ã¨ã„ã†æ–‡è„ˆãªã®ã§ use up ãŒé©åˆ‡ã§ã™ã€‚ä¾‹ï¼šI used up all the milk.ï¼ˆç‰›ä¹³ã‚’å…¨éƒ¨ä½¿ã£ãŸã€‚ï¼‰We ran out of sugar.ï¼ˆç ‚ç³–ãŒåˆ‡ã‚ŒãŸã€‚ï¼‰ã€

ã€ŒEspecially ã«ã¤ã„ã¦ï¼ˆâœ… æ­£ã—ã„å‰¯è©é¸æŠã§ã™ï¼‰
è§£èª¬ï¼šEspecially ã¯æ­£ã—ã„ã§ã™ã€‚Particularly ã¨ã®ä½¿ã„åˆ†ã‘ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚Especiallyï¼ˆç‰¹ã«ï¼šæ—¥å¸¸ä¼šè©±ã§ã‚‚ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªå ´é¢ã§ã‚‚ä½¿ãˆã‚‹æœ€ã‚‚ä¸€èˆ¬çš„ãªå¼·èª¿è¡¨ç¾ãƒ»åºƒã„ç¯„å›²ã‹ã‚‰ç‰¹å®šã®äº‹æŸ„ã‚’é¸ã¶ã¨ãï¼‰ï¼Particularlyï¼ˆã¨ã‚Šã‚ã‘ï¼šEspecially ã‚ˆã‚Šã‚„ã‚„å¼·ã„å¼·èª¿ãƒ»ã‚ˆã‚Šå…·ä½“çš„ã§è©³ç´°ãªãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’æŒã¤ï¼‰ã§ã€ã©ã¡ã‚‰ã‚‚æ–‡æ³•çš„ã«æ­£ã—ãã€å¤šãã®å ´é¢ã§äº¤æ›å¯èƒ½ã§ã™ã€‚ä¾‹ï¼šI love fruits, especially apples.ï¼ˆæœç‰©ãŒå¥½ãã§ã€ç‰¹ã«ã‚Šã‚“ã”ãŒå¥½ãã ã€‚ï¼‰This is particularly important in formal situations.ï¼ˆã“ã‚Œã¯ç‰¹ã«ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªå ´é¢ã§é‡è¦ã ã€‚ï¼‰ã€

ã€Œproperly ã«ã¤ã„ã¦ï¼ˆâœ… æ­£ã—ã„èªå½™é¸æŠã§ã™ï¼‰
è§£èª¬ï¼šproperly ã¯æ­£ã—ã„ã§ã™ã€‚correctly ã¨ã®ä½¿ã„åˆ†ã‘ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚properlyï¼ˆé©åˆ‡ã«ãƒ»ãã¡ã‚“ã¨ï¼šè¡Œå‹•ã‚„çŠ¶æ³ãŒæ­£ã—ã„æ–¹æ³•ãƒ»ãƒãƒŠãƒ¼ãƒ»æ‰‹é †ã§ãªã•ã‚Œã‚‹ã“ã¨ã‚’è¡¨ã™ï¼šæ—¥å¸¸çš„ãªä½œæ¥­ã‚„æŒ¯ã‚‹èˆã„ã®æ–‡è„ˆï¼‰ï¼correctlyï¼ˆæ­£ç¢ºã«ï¼šäº‹å®Ÿã‚„ç­”ãˆãŒé–“é•ã„ãªãæ­£ã—ã„ã“ã¨ã‚’è¡¨ã™ï¼šãƒ†ã‚¹ãƒˆãƒ»è¨ˆç®—ãƒ»äº‹å®Ÿç¢ºèªã®æ–‡è„ˆï¼‰ã§ã€ä»Šå›ã¯è¡Œå‹•ãŒé©åˆ‡ã«ãªã•ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã™ãŸã‚ properly ãŒé©åˆ‡ã§ã™ã€‚ä¾‹ï¼šMake sure you do the job properly.ï¼ˆãã¡ã‚“ã¨ä»•äº‹ã‚’ã—ãªã•ã„ã€‚ï¼‰Please answer the questions correctly.ï¼ˆè³ªå•ã«æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„ã€‚ï¼‰ã€

ã€ŒâŒ by anyone ã«ã¤ã„ã¦ï¼ˆå‰ç½®è©ã¨ä»£åè©ã®èª¤ã‚Šï¼‰
è§£èª¬ï¼šã“ã®æ–‡ã«ã¯2ã¤ã®èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚
1. å‰ç½®è©ã®èª¤ã‚Šï¼štake responsibility forï¼ˆã€œã®è²¬ä»»ã‚’å–ã‚‹ï¼šè²¬ä»»ã®å¯¾è±¡ã‚’ç¤ºã™å‰ç½®è©ã¯ forï¼‰ã§ã‚ã‚Šã€by ã¯ä½¿ã„ã¾ã›ã‚“ã€‚take responsibility by ã¯èª¤ã£ãŸè¡¨ç¾ã§ã™ã€‚
2. ä»£åè©ã®èª¤ã‚Šï¼šã€Œèª°ã‹ã«ã‚ˆã£ã¦ã€ã¨ã„ã†æ„å‘³ã® by anyone ã¯æ–‡è„ˆã«åˆã„ã¾ã›ã‚“ã€‚ãƒšãƒƒãƒˆã«å¯¾ã™ã‚‹è²¬ä»»ã‚’è¡¨ã™ãŸã‚ for itï¼ˆãã‚Œã«å¯¾ã—ã¦ï¼‰ãŒé©åˆ‡ã§ã™ã€‚
ä¾‹ï¼šI take responsibility for this mistake.ï¼ˆã“ã®é–“é•ã„ã®è²¬ä»»ã‚’å–ã‚Šã¾ã™ã€‚ï¼‰He takes responsibility for his family.ï¼ˆå½¼ã¯å®¶æ—ã«å¯¾ã™ã‚‹è²¬ä»»ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ï¼‰ã€

ã€Œgreat power ã«ã¤ã„ã¦ï¼ˆâœ… æ­£ã—ã„è¡¨ç¾ã§ã™ï¼‰
è§£èª¬ï¼šgreat power ã¯æ­£ã—ã„è¡¨ç¾ã§ã™ã€‚å½¢å®¹è©ã¨åè©ã®ä½¿ã„åˆ†ã‘ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚greatï¼ˆç´ æ™´ã‚‰ã—ã„ãƒ»å‰å¤§ãªï¼šæŠ½è±¡çš„ã§å¤§ããªä¾¡å€¤ã‚„å½±éŸ¿ã‚’æŒã¤ã‚‚ã®ã‚’è¡¨ç¾ã™ã‚‹å ´é¢ï¼‰ï¼goodï¼ˆè‰¯ã„ï¼šä¸€èˆ¬çš„ãªè‚¯å®šçš„è©•ä¾¡ã‚’ç¤ºã™å ´é¢ï¼‰ã§ã€ä»Šå›ã¯éŸ³æ¥½ã®å¼·ã„å½±éŸ¿åŠ›ã‚’å¼·èª¿ã™ã‚‹ãŸã‚ great ãŒé©åˆ‡ã§ã™ã€‚ã¾ãŸã€powerï¼ˆåŠ›ãƒ»å½±éŸ¿åŠ›ï¼šç‰©äº‹ã‚’å‹•ã‹ã™æŠ½è±¡çš„ãªåŠ›ã‚’æŒ‡ã™ï¼šæ„Ÿæƒ…ã‚„ç¤¾ä¼šã«å½±éŸ¿ã‚’ä¸ãˆã‚‹æ–‡è„ˆï¼‰ï¼strengthï¼ˆå¼·ã•ï¼šç‰©ç†çš„ã¾ãŸã¯ç²¾ç¥çš„ãªå¼·ã•ã‚’æŒ‡ã™ï¼šä½“åŠ›ã‚„æ„å¿—ã®å¼·ã•ã®æ–‡è„ˆï¼‰ï¼energyï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼šæ´»åŠ›ã‚„å…ƒæ°—ã‚’æŒ‡ã™ï¼šæ´»å‹•çš„ãªåŠ›ã®æ–‡è„ˆï¼‰ã§ã€ä»Šå›ã¯éŸ³æ¥½ã®å½±éŸ¿åŠ›ã‚’è¡¨ã™ãŸã‚ power ãŒæœ€ã‚‚é©åˆ‡ã§ã™ã€‚ä¾‹ï¼šMusic has great power to heal.ï¼ˆéŸ³æ¥½ã«ã¯ç™’ã™å¤§ããªåŠ›ãŒã‚ã‚‹ã€‚ï¼‰He is a good person.ï¼ˆå½¼ã¯è‰¯ã„äººã ã€‚ï¼‰She has the strength to overcome difficulties.ï¼ˆå½¼å¥³ã¯å›°é›£ã‚’ä¹—ã‚Šè¶Šãˆã‚‹å¼·ã•ã‚’æŒã£ã¦ã„ã‚‹ã€‚ï¼‰Music gives me energy.ï¼ˆéŸ³æ¥½ã¯ç§ã«å…ƒæ°—ã‚’ä¸ãˆã‚‹ã€‚ï¼‰ã€

# å‡ºåŠ›JSONï¼ˆæ—¥æœ¬èªæå‡ºã®å ´åˆï¼‰
{{
  "original": "{user_answer}",
  "corrected": "å•é¡Œæ–‡ã®æ¨¡ç¯„è§£ç­”ï¼ˆå¿…ãšå„æ–‡ã”ã¨ã«æ”¹è¡Œã™ã‚‹ã“ã¨ã€‚4æ–‡ã‚ã‚Œã°4ã¤ã®æ®µè½ã«åˆ†ã‘ã‚‹ï¼‰",
  "word_count": 58,
  "points": [
    {{
      "before": "âŒ è‹±æ–‡ã§å›ç­”ã—ã¦ãã ã•ã„",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª1æ–‡ç›®ï¼‰",
      "reason": "è‹±æ–‡ã§ã®å›ç­”ãŒå¿…è¦ã§ã™\nè§£èª¬ï¼šã“ã®èª²é¡Œã¯è‹±ä½œæ–‡ã®ç·´ç¿’ã§ã™ã€‚æ—¥æœ¬èªã§ã¯ãªãã€è‹±æ–‡ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã€æ¨¡ç¯„è§£ç­”ã¨ãã®è§£èª¬ã‚’ç¤ºã—ã¾ã™ã€‚",
      "level": "è‹±æ–‡ãŒå¿…è¦"
    }},
    {{
      "before": "âŒ è‹±æ–‡ã§å›ç­”ã—ã¦ãã ã•ã„",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª1æ–‡ç›®ï¼‰",
      "reason": "èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦ï¼ˆæ¨¡ç¯„è§£ç­”ã®è§£èª¬ï¼‰\nè§£èª¬ï¼šã€Œèªå½™Aï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ï¼èªå½™Bï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ã€ã®å½¢å¼ã§è©³ç´°ãªä½¿ã„åˆ†ã‘ã¨ã€å…·ä½“ä¾‹ãƒ»ä¾‹æ–‡ã‚’å«ã‚€æ—¥æœ¬èªè§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ è‹±æ–‡ã§å›ç­”ã—ã¦ãã ã•ã„",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª2æ–‡ç›®ï¼‰",
      "reason": "2æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ è‹±æ–‡ã§å›ç­”ã—ã¦ãã ã•ã„",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª3æ–‡ç›®ï¼‰",
      "reason": "3æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ è‹±æ–‡ã§å›ç­”ã—ã¦ãã ã•ã„",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª4æ–‡ç›®ï¼‰",
      "reason": "4æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }}
  ]
}}

# å‡ºåŠ›JSONï¼ˆå•é¡Œæ–‡ã¨å†…å®¹ãŒç•°ãªã‚‹å ´åˆï¼‰
{{
  "original": "{user_answer}",
  "corrected": "å•é¡Œæ–‡ã®æ¨¡ç¯„è§£ç­”ï¼ˆå¿…ãšå„æ–‡ã”ã¨ã«æ”¹è¡Œã™ã‚‹ã“ã¨ã€‚4æ–‡ã‚ã‚Œã°4ã¤ã®æ®µè½ã«åˆ†ã‘ã‚‹ï¼‰",
  "word_count": 58,
  "points": [
    {{
      "before": "âŒ å•é¡Œæ–‡ã®å†…å®¹ã¨ç•°ãªã‚Šã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª1æ–‡ç›®ï¼‰",
      "reason": "å†…å®¹ä¸ä¸€è‡´ã«ã¤ã„ã¦\nè§£èª¬ï¼šæå‡ºã•ã‚ŒãŸè‹±æ–‡ã¯ã€å•é¡Œæ–‡ã®å†…å®¹ã¨ç•°ãªã‚Šã¾ã™ã€‚å•é¡Œæ–‡ã®ãƒ†ãƒ¼ãƒã¯ã€Œ{japanese_text}ã®1æ–‡ç›®ã€ã§ã™ãŒã€å›ç­”ã¯åˆ¥ã®å†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚æ­£ã—ã„å†…å®¹ã§è‹±ä½œæ–‡ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã€æ¨¡ç¯„è§£ç­”ã¨ãã®è§£èª¬ã‚’ç¤ºã—ã¾ã™ã€‚",
      "level": "å†…å®¹ä¸ä¸€è‡´"
    }},
    {{
      "before": "âŒ å•é¡Œæ–‡ã®å†…å®¹ã¨ç•°ãªã‚Šã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª1æ–‡ç›®ï¼‰",
      "reason": "èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦ï¼ˆæ¨¡ç¯„è§£ç­”ã®è§£èª¬ï¼‰\nè§£èª¬ï¼šã€Œèªå½™Aï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ï¼èªå½™Bï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ã€ã®å½¢å¼ã§è©³ç´°ãªä½¿ã„åˆ†ã‘ã¨ã€å…·ä½“ä¾‹ãƒ»ä¾‹æ–‡ã‚’å«ã‚€æ—¥æœ¬èªè§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ å•é¡Œæ–‡ã®å†…å®¹ã¨ç•°ãªã‚Šã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª2æ–‡ç›®ï¼‰",
      "reason": "2æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ å•é¡Œæ–‡ã®å†…å®¹ã¨ç•°ãªã‚Šã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª3æ–‡ç›®ï¼‰",
      "reason": "3æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ å•é¡Œæ–‡ã®å†…å®¹ã¨ç•°ãªã‚Šã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª4æ–‡ç›®ï¼‰",
      "reason": "4æ–‡ç›®ã®è§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }}
  ]
}}

# å‡ºåŠ›JSONï¼ˆæ–‡æ•°ä¸è¶³ã®å ´åˆï¼šä¾‹ãˆã°å•é¡Œæ–‡4æ–‡ãªã®ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ2æ–‡ã—ã‹æå‡ºã—ã¦ã„ãªã„å ´åˆï¼‰
{{
  "original": "{user_answer}",
  "corrected": "å•é¡Œæ–‡å…¨ä½“ï¼ˆ4æ–‡ï¼‰ã‚’æ­£ã—ãè‹±è¨³ã—ãŸå®Œå…¨ãªæ¨¡ç¯„è§£ç­”",
  "word_count": 58,
  "points": [
    {{
      "before": "âŒ æ–‡æ•°ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ4æ–‡å¿…è¦ã§ã™ï¼‰",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª1æ–‡ç›®ï¼‰",
      "reason": "æ–‡æ•°ä¸è¶³ã«ã¤ã„ã¦\nè§£èª¬ï¼šå•é¡Œæ–‡ã¯4æ–‡ã§ã™ãŒã€å›ç­”ã¯2æ–‡ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚1æ–‡ç›®ã¨2æ–‡ç›®ãŒæ¬ ã‘ã¦ã„ã¾ã™ã€‚ã™ã¹ã¦ã®å•é¡Œæ–‡ã«å¯¾å¿œã™ã‚‹è‹±æ–‡ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚",
      "level": "æ–‡æ•°ä¸è¶³"
    }},
    {{
      "before": "âŒ 1æ–‡ç›®ãŒæ¬ ã‘ã¦ã„ã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª1æ–‡ç›®ï¼‰",
      "reason": "1æ–‡ç›®ã®è§£èª¬ï¼ˆæ¨¡ç¯„è§£ç­”ã®èªå½™ãƒ»è¡¨ç¾ã«ã¤ã„ã¦ï¼‰\nè§£èª¬ï¼šã€Œèªå½™Aï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ï¼èªå½™Bï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ã€ã®å½¢å¼ã§è©³ç´°ãªä½¿ã„åˆ†ã‘ã¨ã€å…·ä½“ä¾‹ãƒ»ä¾‹æ–‡ã‚’å«ã‚€æ—¥æœ¬èªè§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "âŒ 2æ–‡ç›®ãŒæ¬ ã‘ã¦ã„ã¾ã™",
      "after": "ï¼ˆæ¨¡ç¯„è§£ç­”ã®å®Œå…¨ãª2æ–‡ç›®ï¼‰",
      "reason": "2æ–‡ç›®ã®è§£èª¬ï¼ˆæ¨¡ç¯„è§£ç­”ã®èªå½™ãƒ»è¡¨ç¾ã«ã¤ã„ã¦ï¼‰",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›¸ã„ãŸ1æ–‡ç›®ï¼‰",
      "after": "ï¼ˆæ·»å‰Šã—ãŸ3æ–‡ç›®ï¼‰",
      "reason": "3æ–‡ç›®ã®è§£èª¬ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’æ·»å‰Šï¼‰",
      "level": "æ­£ã—ã„/æ”¹å–„ç‚¹"
    }},
    {{
      "before": "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›¸ã„ãŸ2æ–‡ç›®ï¼‰",
      "after": "ï¼ˆæ·»å‰Šã—ãŸ4æ–‡ç›®ï¼‰",
      "reason": "4æ–‡ç›®ã®è§£èª¬ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’æ·»å‰Šï¼‰",
      "level": "æ­£ã—ã„/æ”¹å–„ç‚¹"
    }}
  ]
}}

# å‡ºåŠ›JSONï¼ˆé€šå¸¸ã®æ·»å‰Šã®å ´åˆï¼‰
# ã€é‡è¦ã€‘pointsã®æ•°ã¯ã€å¿…ãšæ—¥æœ¬èªå•é¡Œæ–‡ã®æ–‡æ•°ã¨åŒã˜ã«ã™ã‚‹ã“ã¨ï¼ˆä¾‹ï¼šå•é¡Œæ–‡ãŒ4æ–‡ãªã‚‰ã€pointsã‚‚4ã¤ï¼‰
{{
  "original": "{user_answer}",
  "corrected": "å­¦ç”Ÿã®å›ç­”ã®æ¸›ç‚¹å¯¾è±¡ã¨ãªã‚‹æ˜ç¢ºãªèª¤ã‚Šã®ã¿ã‚’ä¿®æ­£ã—ãŸã‚‚ã®ï¼ˆæ–‡æ³•ãƒŸã‚¹ã€ã‚¹ãƒšãƒ«ãƒŸã‚¹ã€èªé †ãƒŸã‚¹ã®ã¿ä¿®æ­£ã€‚ä¸å¿…è¦ãªè¨€ã„æ›ãˆã¯è¡Œã‚ãªã„ã€‚å­¦ç”Ÿã®è¡¨ç¾ã‚’æœ€å¤§é™å°Šé‡ã™ã‚‹ã“ã¨ï¼‰",
  "word_count": 58,
  "points": [
    {{
      "before": "1æ–‡ç›®ã®å­¦ç”Ÿã®è¡¨ç¾",
      "after": "1æ–‡ç›®ã®ä¿®æ­£å¾Œã®è¡¨ç¾ï¼ˆèª¤ã‚ŠãŒãªã„å ´åˆã¯beforeã¨åŒã˜ï¼‰",
      "reason": "1æ–‡ç›®ã®èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦ï¼ˆâœ“ æ­£ã—ã„èªå½™é¸æŠã§ã™ / âœ“ ã©ã¡ã‚‰ã‚‚æ­£ã—ã„è¡¨ç¾ã§ã™ / ğŸ’¡ æ”¹å–„ç‚¹ / âŒ æ–‡æ³•ãƒŸã‚¹ï¼‰\nè§£èª¬ï¼šã€Œèªå½™Aï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ï¼èªå½™Bï¼ˆæ„å‘³ãƒ»ç”¨æ³•ï¼šæ–‡è„ˆï¼‰ã€ã®å½¢å¼ã§è©³ç´°ãªä½¿ã„åˆ†ã‘ã¨ã€å…·ä½“ä¾‹ãƒ»ä¾‹æ–‡ã‚’å«ã‚€æ—¥æœ¬èªè§£èª¬",
      "level": "æ­£ã—ã„èªå½™é¸æŠã§ã™"
    }},
    {{
      "before": "2æ–‡ç›®ã®å­¦ç”Ÿã®è¡¨ç¾",
      "after": "2æ–‡ç›®ã®ä¿®æ­£å¾Œã®è¡¨ç¾ï¼ˆèª¤ã‚ŠãŒãªã„å ´åˆã¯beforeã¨åŒã˜ï¼‰",
      "reason": "2æ–‡ç›®ã®èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦\nè§£èª¬ï¼šè©³ç´°ãªè§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "3æ–‡ç›®ã®å­¦ç”Ÿã®è¡¨ç¾",
      "after": "3æ–‡ç›®ã®ä¿®æ­£å¾Œã®è¡¨ç¾ï¼ˆèª¤ã‚ŠãŒãªã„å ´åˆã¯beforeã¨åŒã˜ï¼‰",
      "reason": "3æ–‡ç›®ã®èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦\nè§£èª¬ï¼šè©³ç´°ãªè§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }},
    {{
      "before": "4æ–‡ç›®ã®å­¦ç”Ÿã®è¡¨ç¾",
      "after": "4æ–‡ç›®ã®ä¿®æ­£å¾Œã®è¡¨ç¾ï¼ˆèª¤ã‚ŠãŒãªã„å ´åˆã¯beforeã¨åŒã˜ï¼‰",
      "reason": "4æ–‡ç›®ã®èªå½™/ç†Ÿèª/æ–‡æ³•ã«ã¤ã„ã¦\nè§£èª¬ï¼šè©³ç´°ãªè§£èª¬",
      "level": "æ­£ã—ã„è¡¨ç¾ã§ã™"
    }}
  ]
}}
      "reason": "3æ–‡ç›®ã®è§£èª¬ï¼ˆèªå½™ã®ä½¿ã„åˆ†ã‘ã‚’ã€ŒAï¼ˆç”¨æ³•ï¼‰ï¼Bï¼ˆç”¨æ³•ï¼‰ã€å½¢å¼ã§ï¼‰",
      "level": "æ­£ã—ã„/æ”¹å–„ç‚¹"
    }},
    {{
      "before": "ä¿®æ­£å‰ã®è¡¨ç¾4",
      "after": "ä¿®æ­£å¾Œã®è¡¨ç¾4",
      "reason": "4æ–‡ç›®ã®è§£èª¬ï¼ˆèªå½™ã®ä½¿ã„åˆ†ã‘ã‚’ã€ŒAï¼ˆç”¨æ³•ï¼‰ï¼Bï¼ˆç”¨æ³•ï¼‰ã€å½¢å¼ã§ï¼‰",
      "level": "æ­£ã—ã„/æ”¹å–„ç‚¹"
    }}
  ]
}}

é‡è¦ãªåˆ¶ç´„:
1. å¿…ãšJSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„
2. Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ```jsonï¼‰ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. originalã¯ãã®ã¾ã¾ã€correctedã¯å®Œå…¨ãªä¿®æ­£ç‰ˆã‚’å‡ºåŠ›ï¼ˆå„æ–‡ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹ã€‚ä¾‹ï¼š"Sentence1. Sentence2. Sentence3. Sentence4."ï¼‰
4. **ã€çµ¶å¯¾å³å®ˆã€‘pointsã¯å¿…ãšæ—¥æœ¬èªå•é¡Œæ–‡ã®æ–‡æ•°ã¨å…¨ãåŒã˜å€‹æ•°ã‚’ä½œæˆã™ã‚‹ã“ã¨**
   - å•é¡Œæ–‡ãŒ4æ–‡ãªã‚‰ã€çµ¶å¯¾ã«4å€‹ã®pointsã‚’ä½œæˆï¼ˆ3å€‹ã‚„5å€‹ã¯ç¦æ­¢ï¼‰
   - å„pointã¯å„æ–‡ã«1å¯¾1ã§å¯¾å¿œã•ã›ã‚‹ï¼špoint[0]=1æ–‡ç›®ã€point[1]=2æ–‡ç›®ã€point[2]=3æ–‡ç›®ã€point[3]=4æ–‡ç›®
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¨æ–‡ã‚’æ›¸ã„ã¦ã„ãªã„å ´åˆã‚‚ã€å¿…ãš4ã¤ã®pointsã‚’ä½œæˆ
   - ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ2æ–‡ã—ã‹æ›¸ã„ã¦ã„ãªã„å ´åˆã§ã‚‚ã€4ã¤ã®pointsã‚’è¿”ã™
     - point[0]: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®1æ–‡ç›®ã‚’æ·»å‰Š
     - point[1]: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®2æ–‡ç›®ã‚’æ·»å‰Š
     - point[2]: ã€ŒâŒ 3æ–‡ç›®ãŒæ¬ ã‘ã¦ã„ã¾ã™ã€+ æ¨¡ç¯„è§£ç­”ã®3æ–‡ç›®
     - point[3]: ã€ŒâŒ 4æ–‡ç›®ãŒæ¬ ã‘ã¦ã„ã¾ã™ã€+ æ¨¡ç¯„è§£ç­”ã®4æ–‡ç›®
5. æ–‡æ•°ãŒè¶³ã‚Šãªã„å ´åˆã¯ã€correctedã«ã¯å•é¡Œæ–‡å…¨ä½“ã‚’æ­£ã—ãè‹±è¨³ã—ãŸå®Œå…¨ãªè§£ç­”ï¼ˆ4æ–‡ï¼‰ã‚’è¨˜è¼‰ã™ã‚‹
6. reasonã«ã¯å¿…ãšã€Œèªå½™/ç†Ÿèªã«ã¤ã„ã¦ï¼ˆæ­£ã—ã„èªå½™é¸æŠã§ã™/æ­£ã—ã„è¡¨ç¾ã§ã™ï¼‰ã€ã®ã‚ˆã†ãªè¦‹å‡ºã—ã¨ã€ã€Œèªå½™Aï¼ˆç”¨æ³•ï¼‰ï¼èªå½™Bï¼ˆç”¨æ³•ï¼‰ã€å½¢å¼ã®è©³ç´°ãªä½¿ã„åˆ†ã‘è§£èª¬ãƒ»ä¾‹æ–‡ã‚’å«ã‚ã‚‹ã“ã¨
7. **ã€é‡è¦ã€‘levelã«ã¯æ­£ç¢ºãªè©•ä¾¡ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨**
   - æ–‡æ³•ãƒŸã‚¹ãƒ»ã‚¹ãƒšãƒ«ãƒŸã‚¹ãªã©æ˜ç¢ºãªèª¤ã‚Šã®å ´åˆï¼šã€Œæ–‡æ³•ãƒŸã‚¹ã€ã€Œã‚¹ãƒšãƒ«ãƒŸã‚¹ã€ãªã©ï¼ˆâŒãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
   - æ­£ã—ã„è¡¨ç¾ã®å ´åˆï¼šã€Œæ­£ã—ã„èªå½™é¸æŠã§ã™ã€ã€Œæ­£ã—ã„è¡¨ç¾ã§ã™ã€ã€Œã©ã¡ã‚‰ã‚‚æ­£ã—ã„è¡¨ç¾ã§ã™ã€ãªã©ï¼ˆâœ…ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
   - æ­£ã—ã„ãŒæ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆï¼šã€Œå…·ä½“æ€§ã®å‘ä¸Šã€ã€Œã‚ˆã‚Šè‡ªç„¶ãªè¡¨ç¾ã€ãªã©ï¼ˆğŸ’¡ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
   
   **ã€æ”¹å–„ææ¡ˆã®å…·ä½“ä¾‹ã€‘**ï¼š
   - Recently + ç¾åœ¨é€²è¡Œå½¢ï¼ˆam havingï¼‰â†’ ç¾åœ¨å®Œäº†é€²è¡Œå½¢ï¼ˆhave been havingï¼‰ï¼šæ–‡æ³•çš„ã«ã¯æ­£ã—ã„ãŒã€ã€Œæœ€è¿‘ãšã£ã¨ã€ã¨ã„ã†ç¶™ç¶šã‚’è¡¨ã™å ´åˆã¯ç¾åœ¨å®Œäº†é€²è¡Œå½¢ãŒã‚ˆã‚Šè‡ªç„¶ â†’ level: "ã‚ˆã‚Šè‡ªç„¶ãªè¡¨ç¾"
   - ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã™ãã‚‹è¡¨ç¾ï¼ˆa lot of â†’ many/muchï¼‰ï¼šãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡è„ˆã§ã®æ”¹å–„ææ¡ˆ â†’ level: "ã‚ˆã‚Šé©åˆ‡ãªè¡¨ç¾"
   - å…·ä½“æ€§ã®æ¬ å¦‚ï¼ˆit â†’ specific nounï¼‰ï¼šæ„å‘³ã¯é€šã˜ã‚‹ãŒå…·ä½“çš„ã«ã—ãŸæ–¹ãŒã‚ˆã„ â†’ level: "å…·ä½“æ€§ã®å‘ä¸Š"
   
   **ã€é‡è¦ã€‘æ”¹å–„ææ¡ˆã¨ã—ã¦æ‰±ã†ã¹ãã‚±ãƒ¼ã‚¹**ï¼š
   - æ–‡æ³•çš„ã«æ­£ã—ã„ãŒã€æ–‡è„ˆã‚„çŠ¶æ³ã«ã‚ˆã‚Šè‡ªç„¶ãªåˆ¥ã®æ™‚åˆ¶ãƒ»è¡¨ç¾ãŒã‚ã‚‹å ´åˆ
   - æ¸›ç‚¹å¯¾è±¡ã«ã¯ãªã‚‰ãªã„ãŒã€ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸèªå½™é¸æŠãŒã‚ã‚‹å ´åˆ
   - æ„å‘³ã¯é€šã˜ã‚‹ãŒã€ã‚ˆã‚Šæ˜ç¢ºã§å…·ä½“çš„ãªè¡¨ç¾ãŒã‚ã‚‹å ´åˆ
   
   **ã€æ”¹å–„ææ¡ˆã¨ã—ã¦æ‰±ã‚ãªã„ã‚±ãƒ¼ã‚¹ã€‘**ï¼š
   - å˜ãªã‚‹å¥½ã¿ã®é•ã„ï¼ˆè¤‡æ•°ã®è¡¨ç¾ãŒå®Œå…¨ã«åŒç­‰ã®å ´åˆï¼‰
   - å£èª/ãƒ•ã‚©ãƒ¼ãƒãƒ«ã®é¸æŠãŒæ–‡è„ˆã«åˆã£ã¦ã„ã‚‹å ´åˆ
   
8. å£èªçš„æ–‡è„ˆï¼ˆã€œã ã‚ˆ/ã€œã­ï¼‰ã§ã¯ã€So/pretty/big ãªã©ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¾ã‚’æ­£ã—ã„ã¨è©•ä¾¡ã—ã€Therefore/quite/significant ãªã©ã®ãƒ•ã‚©ãƒ¼ãƒãƒ«è¡¨ç¾ã‚’å¼·è¦ã—ãªã„ã“ã¨
9. altã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãªã„å ´åˆã¯ã‚­ãƒ¼è‡ªä½“ã‚’çœç•¥ï¼‰
10. reasonã¯å¿…ãšæ—¥æœ¬èªã§è¨˜è¼‰ã—ã€è‹±èªè§£èª¬ã¯ç¦æ­¢
"""


# ===== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¾æ›¸ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰ =====
PROMPTS = {
    'question': QUESTION_PROMPT_GENERAL,
    'correction': CORRECTION_PROMPT_TEMPLATE
}


# ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====

def clean_json_response(response: str) -> str:
    """LLMã®å‡ºåŠ›ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã€åˆ¶å¾¡æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—"""
    import re
    
    response = response.strip()
    
    # Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
    if response.startswith('```'):
        lines = response.split('\n')
        lines = [line for line in lines if not line.startswith('```')]
        response = '\n'.join(lines)
    
    # å…ˆé ­ã¨æœ«å°¾ã®ç©ºç™½ã‚’å‰Šé™¤
    response = response.strip()
    
    # JSONã®é–‹å§‹ã‚’æ¤œç´¢
    start_idx = response.find('{')
    end_idx = response.rfind('}')
    
    if start_idx != -1 and end_idx != -1:
        response = response[start_idx:end_idx+1]
    
    # æ–‡å­—åˆ—å†…ã®åˆ¶å¾¡æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆãŸã ã—æ”¹è¡Œã¯\\nã«å¤‰æ›ï¼‰
    # JSONæ–‡å­—åˆ—å†…ã®ä¸æ­£ãªåˆ¶å¾¡æ–‡å­—ã‚’å‰Šé™¤
    response = re.sub(r'[\x00-\x08\x0b-\x0c\x0e-\x1f]', '', response)
    
    return response


def call_openai_with_retry(prompt: str, max_retries: int = 3) -> str:
    """OpenAI APIã‚’ãƒªãƒˆãƒ©ã‚¤ä»˜ãã§å‘¼ã³å‡ºã—"""
    for attempt in range(max_retries):
        try:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": "ã‚ãªãŸã¯æ—¥æœ¬ã®å¤§å­¦å…¥è©¦è‹±ä½œæ–‡ã®å°‚é–€å®¶ã§ã™ã€‚å¿…ãšJSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚"},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.7,
                max_tokens=2000
            )
            
            content = response.choices[0].message.content
            logger.info(f"OpenAI API response (attempt {attempt + 1}): {content[:200]}...")
            
            return content
            
        except Exception as e:
            logger.error(f"OpenAI API error (attempt {attempt + 1}): {e}")
            if attempt == max_retries - 1:
                raise
    
    raise Exception("Failed to get response from OpenAI after retries")


# ===== å‡ºé¡Œã‚µãƒ¼ãƒ“ã‚¹ =====

def generate_question(difficulty: str = "intermediate", excluded_themes: List[str] = None) -> QuestionResponse:
    """
    å•é¡Œã‚’ç”Ÿæˆï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    
    Args:
        difficulty: é›£æ˜“åº¦
        excluded_themes: é™¤å¤–ã™ã‚‹ãƒ†ãƒ¼ãƒã®ãƒªã‚¹ãƒˆ
    """
    if excluded_themes is None:
        excluded_themes = []
    
    # LLMãƒ™ãƒ¼ã‚¹ç”Ÿæˆ
    logger.info("Using LLM-based question generation")
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
    prompt_template = PROMPTS['question']
    
    prompt = prompt_template.format(
        difficulty=difficulty,
        excluded_themes=", ".join(excluded_themes) if excluded_themes else "ãªã—"
    )
    
    max_retries = 3
    for attempt in range(max_retries):
        try:
            # OpenAI APIã‚’å‘¼ã³å‡ºã—
            response = call_openai_with_retry(prompt)
            
            # JSONã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            cleaned = clean_json_response(response)
            logger.info(f"Cleaned JSON (attempt {attempt + 1}): {cleaned[:300]}...")
            
            # JSONã‚’ãƒ‘ãƒ¼ã‚¹
            data = json.loads(cleaned)
            
            # Pydanticã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            question = QuestionResponse(**data)
            
            logger.info(f"Successfully generated question: {question.theme}")
            return question
            
        except (json.JSONDecodeError, ValidationError) as e:
            logger.warning(f"Question generation failed (attempt {attempt + 1}): {e}")
            
            if attempt == max_retries - 1:
                # æœ€å¾Œã®ãƒªãƒˆãƒ©ã‚¤ã§ã‚‚å¤±æ•—ã—ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                logger.error("All retries failed, returning fallback question")
                return _get_fallback_question()
    
    return _get_fallback_question()


def _get_fallback_question() -> QuestionResponse:
    """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®å›ºå®šå•é¡Œ"""
    return QuestionResponse(
        theme="YouTubeãƒãƒ£ãƒ³ãƒãƒ«",
        question_text="Imagine that you wanted to make a YouTube channel. What would your channel be about? Give two reasons to support your answer.",
        japanese_sentences=[],  # å¤§å•ï¼•å½¢å¼ã§ã¯ä¸è¦
        hints=[
            {"en": "create", "ja": "ä½œã‚‹", "kana": "ã¤ãã‚‹", "pos": "å‹•è©", "usage": "create Aã€ŒAã‚’ä½œã‚‹ã€"},
            {"en": "share", "ja": "å…±æœ‰ã™ã‚‹", "kana": "ãã‚‡ã†ã‚†ã†ã™ã‚‹", "pos": "å‹•è©", "usage": "share A with Bã€ŒAã‚’Bã¨å…±æœ‰ã™ã‚‹ã€"},
            {"en": "content", "ja": "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„", "kana": "ã“ã‚“ã¦ã‚“ã¤", "pos": "åè©"},
            {"en": "interested", "ja": "èˆˆå‘³ã®ã‚ã‚‹", "kana": "ãã‚‡ã†ã¿ã®ã‚ã‚‹", "pos": "å½¢å®¹è©"},
            {"en": "subscriber", "ja": "ç™»éŒ²è€…", "kana": "ã¨ã†ã‚ãã—ã‚ƒ", "pos": "åè©"}
        ],
        target_words=TargetWords(min=100, max=120),
        model_answer="If I created a YouTube channel, it would be about cooking simple and healthy meals. First, many people are busy and need quick recipes that are also nutritious. Second, I enjoy cooking and want to share my passion with others who might be interested in learning. By creating easy-to-follow videos, I could help viewers improve their cooking skills while making healthy choices. This would allow me to connect with people who share similar interests and build a supportive community around healthy eating habits.",
        alternative_answer="I would make a YouTube channel about traveling to different countries and experiencing their cultures. First, traveling helps people understand different ways of life and broadens their perspectives. Second, I love exploring new places and trying local foods, and I want to inspire others to travel more. Through my videos, I could show viewers interesting destinations and give them practical tips for their own trips. This would be a great way to share my experiences and encourage people to step out of their comfort zones.",
        common_mistakes=["ç†ç”±ãŒ1ã¤ã—ã‹æ›¸ã‘ã¦ã„ãªã„", "èªæ•°ãŒ100èªæœªæº€", "è³ªå•ã«ç­”ãˆã¦ã„ãªã„"]
    )


# ===== æ·»å‰Šã‚µãƒ¼ãƒ“ã‚¹ =====

def correct_answer(submission: SubmissionRequest) -> CorrectionResponse:
    """
    è‹±ä½œæ–‡ã‚’æ·»å‰Šï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    
    Args:
        submission: æå‡ºãƒ‡ãƒ¼ã‚¿
    """
    # å•é¡Œæ–‡ã‚’å–å¾—ï¼ˆæ–°å½¢å¼ã¾ãŸã¯æ—§å½¢å¼ï¼‰
    if submission.question_text:
        japanese_text = submission.question_text
    else:
        japanese_text = "\n".join(submission.japanese_sentences or [])
    
    # Phase 1: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ï¼ˆæ±ºå®šçš„ï¼‰
    logger.info("Phase 1: Running server-side constraint checks...")
    constraints_result = validate_constraints_func(
        text=submission.user_answer,
        min_words=submission.target_words.min,
        max_words=submission.target_words.max,
        required_units=2  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2ã¤ã®ç†ç”±/ææ¡ˆ/ä¾‹
    )
    
    constraints = ConstraintChecks(**constraints_result)
    logger.info(f"Constraints check: word_count={constraints.word_count}, "
                f"within_range={constraints.within_word_range}, "
                f"detected_units={constraints.detected_units}/{constraints.required_units}")
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
    prompts = PROMPTS
    
    # Step 1: æ·»å‰Šã‚’å®Ÿè¡Œ
    correction_prompt = prompts['correction'].format(
        japanese_text=japanese_text,
        user_answer=submission.user_answer
    )
    
    max_retries = 3
    correction_data = None
    
    for attempt in range(max_retries):
        try:
            response = call_openai_with_retry(correction_prompt)
            cleaned = clean_json_response(response)
            logger.info(f"Correction JSON (attempt {attempt + 1}): {cleaned[:300]}...")
            
            correction_data = json.loads(cleaned)
            
            # pointsã®æœ€å°æ•°ã‚’æ¤œè¨¼ï¼ˆæ—¥æœ¬èªæ–‡ã®æ•°ã«åˆã‚ã›ã‚‹ï¼‰
            points = correction_data.get('points', [])
            sentence_count = len(submission.japanese_sentences)
            
            # æ—¥æœ¬èªæ–‡ã®æ•°ã«å¿œã˜ãŸå¿…è¦ãƒã‚¤ãƒ³ãƒˆæ•°ï¼ˆå¿…ãšæ–‡ã®æ•°ã¨åŒã˜ï¼‰
            required_points = sentence_count
            
            if len(points) < required_points:
                logger.warning(f"Not enough points: {len(points)} < {required_points}. Retrying...")
                if attempt < max_retries - 1:
                    continue
                else:
                    # æœ€å¾Œã®è©¦è¡Œã§ã‚‚ä¸ååˆ†ãªå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è£œå®Œ
                    logger.error(f"Failed to get enough points after {max_retries} attempts. Padding with placeholder points.")
                    while len(points) < required_points:
                        missing_idx = len(points) + 1
                        points.append({
                            "before": f"âŒ {missing_idx}æ–‡ç›®ãŒæ¬ ã‘ã¦ã„ã¾ã™",
                            "after": f"ï¼ˆ{missing_idx}æ–‡ç›®ã®æ¨¡ç¯„è§£ç­”ãŒå¿…è¦ã§ã™ï¼‰",
                            "reason": f"{missing_idx}æ–‡ç›®ã®è§£èª¬ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
                            "level": "ã‚¨ãƒ©ãƒ¼"
                        })
                    correction_data['points'] = points
            
            break
            
        except (json.JSONDecodeError, ValueError) as e:
            logger.warning(f"Correction parsing failed (attempt {attempt + 1}): {e}")
            if attempt == max_retries - 1:
                raise
    
    if not correction_data:
        raise ValueError("Failed to generate correction data")
    
    # çµ±åˆã—ã¦è¿”ã™ï¼ˆconstraint_checks ã‚’è¿½åŠ ã€æ¡ç‚¹ãªã—ï¼‰
    final_data = {**correction_data, "constraint_checks": constraints.model_dump()}
    
    # Pydanticã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    correction_response = CorrectionResponse(**final_data)
    
    logger.info(f"Successfully corrected answer")
    return correction_response

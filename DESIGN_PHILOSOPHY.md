# 設計思想：段落抜粋出題システム

## 📌 設計の背景と目的

### なぜ「段落抜粋出題」なのか

#### 1. ユーザー疲労の軽減
- **問題**: 過去問は3〜5段落の長文だが、すべてを出題するとユーザーが疲れる
- **解決策**: 全文の一部（1〜2段落）だけを抜粋して出題
- **効果**: 適切な分量（100-120語相当）で集中して取り組める

#### 2. 多様な訓練の実現
- **問題**: 導入部分だけの訓練に偏ると、方法・結果・評価部分の英訳力が育たない
- **解決策**: 文章のどの部分でも出題できるようにする
  - 導入（背景/概要）
  - 方法（手順/条件）
  - 結果（データ/効果）
  - 評価（考察/提案）
- **効果**: 構成要素すべてに対応できる実践力が身につく

#### 3. 過去問の構造に忠実
- **実際の入試**: 宮崎大学医学部の過去問は完結した長文ではなく、文章の一部を切り取ったような問題が多い
- **設計方針**: その特徴を再現し、本番に近い環境で訓練できるようにする

---

## 🎯 過去問分析から導かれた設計原則

### 【宮崎大学医学部 過去問の特徴】

#### 2025年度（研究紹介・4段落）
```
段落① 研究の概要（右手/左手の握りと記憶）
段落② 実験方法（4グループ、72語リスト）
段落③ 各グループの条件（詳細）
段落④ 結果（右→左グループが最良）
```
**出題想定:**
- 「段落②のみ」（方法部分だけ）
- 「段落③+④」（条件と結果）
- 「段落④のみ」（結果だけ）

#### 2024年度（時事・5段落）
```
段落① 背景（Snowdenの経歴）
段落② 暴露内容①（Verizon経由の通話記録）
段落③ 暴露内容②（PRISMプログラム）
段落④ プログラムの影響（閲覧履歴等）
段落⑤ 評価の分裂（裏切り者 vs 英雄）
```
**出題想定:**
- 「段落③+④」（PRISM説明と影響）
- 「段落⑤のみ」（評価部分）

#### 2021年度（レビュー・実質2段落相当）
```
段落①+② 主人公の仕事と姿勢（出題せず）
段落③+④ 映画のテーマとラストシーン（抜粋出題）
```
**実際の出題:**
> 人と向き合うことの難しさと大切さを描いたヒューマンドラマです。
> ジョンの最後の仕事を、より多くの人に見届けてほしいと思わせる印象的なラストシーンでした。
> 人を許すことの意味を教えてくれる、心を浄化してくれる作品です。

→ 「ジョン」が誰か説明がない（抜粋感）  
→ テーマ部分から始まっている（導入ではない）

---

## 🏗️ システム設計の3本柱

### 1. 抜粋タイプの明示化

#### 定義した抜粋パターン
| タイプ | 説明 | 段落数 | 確率 | 用途 |
|--------|------|--------|------|------|
| P1_ONLY | 導入のみ | 1 | 20% | 背景/概要/問題提起 |
| P2_P3 | 中盤 | 2 | 50% | 方法/条件/比較/影響 |
| P3_ONLY | 結果/評価のみ | 1 | 20% | 結果/効果/評価 |
| P4_P5 | 結論 | 2 | 10% | まとめ/提案/見通し |
| MIDDLE | 中盤（汎用） | 1-2 | - | 柔軟な抜粋 |

#### なぜ明示化が必要か
1. **品質保証**: 生成物が設計通りか検証できる
2. **ユーザー理解**: UI表示で「抜粋」であることを明示
3. **偏り防止**: DB記録で同じタイプの連続を避ける
4. **運用改善**: データ分析で問題の傾向を把握

### 2. 抜粋の自然さの担保

#### 抜粋として成立する条件
- ✅ **接続語の使用**: 「その結果」「一方で」「また」など前後を匂わせる
- ✅ **前提の最小限化**: 指示語で破綻しないよう冒頭に軽く前提を置く
- ❌ **完結性の排除**: 導入→展開→結論が揃わないようにする
- ❌ **全文感の回避**: P1から始まって結論まで行くのを禁止

#### 良い抜粋の例（P3_ONLY）
```
その結果、リストを記憶する際に右手を握りしめ、単語を思い出す際に左手を
握りしめたグループは、他のグループより良い成績を記録しました。
```
- 「その結果」で前の文脈を匂わせる
- 結果部分のみで完結しており、導入がない
- 抜粋感がある

#### 悪い抜粋の例（完結しすぎ）
```
ある研究によると、右手を握ることで記憶が強化されます。
実験を行った結果、右→左グループが最良でした。
この発見は教育現場で活用できるでしょう。
```
- 導入→結果→提案が揃っている（完結しすぎ）
- 抜粋ではなく、独立した短文

### 3. バリデーションによる品質担保

#### 実装したチェック機構
1. **段落数チェック**: 1〜3段落に制限
2. **タイプ整合性**: excerpt_typeと段落数が一致するか
3. **文数チェック**: 1段落5文以内（長すぎる段落を弾く）
4. **リトライ機能**: 条件違反時は修正指示付きで再生成

---

## 🔄 生成フロー設計

### Step 1: 全文の想定（出力しない）
```
LLMが頭の中で3〜5段落の完全な文章を構成する

例（研究紹介）:
段落① 研究の概要
段落② 実験方法
段落③ 実験条件
段落④ 結果
段落⑤ 考察（任意）
```

### Step 2: 抜粋部分の選択
```
抜粋タイプに基づいて出題範囲を決定

P1_ONLY → 段落①のみ
P2_P3   → 段落②+③
P3_ONLY → 段落③のみ
P4_P5   → 段落④+⑤
```

### Step 3: 抜粋のみを出力
```
選択した段落だけをjapanese_paragraphsに含める
全文は出力しない
```

### Step 4: バリデーション
```
models.pyでexcerpt_typeと段落数の整合性をチェック
不一致ならValueError発生 → リトライ
```

### Step 5: リトライ（必要時）
```
エラー理由を解析:
- paragraph_count_mismatch
- too_many_sentences
- missing_excerpt_type

次回生成時に修正指示を追記してリトライ
```

---

## 🎨 UI/UX設計思想

### 抜粋であることの明示
```
📌 テーマ: 研究紹介　　下記を英訳せよ
（抜粋：段落②〜③）
• その研究では、参加者を4つのグループに分け...
• 1つのグループは、リストを記憶する直前に...
```

#### なぜ明示するのか
1. **混乱防止**: ユーザーが「情報不足」と誤解しないように
2. **訓練意識**: 「抜粋でも対応できる力」を養う意識づけ
3. **実践的**: 本番の入試でも文脈不足の問題が出る

### シンプルな箇条書き表示
- 装飾を排除（ボーダー、背景色なし）
- 通常のulタグで箇条書き
- テーマヘッダーも控えめに

#### なぜシンプルか
> 「下記部分のスタイルが気に入らない、普通に箇条書き表示でいい、余計な装飾いらない」
> — ユーザーからのフィードバック

→ 読みやすさ優先、装飾は最小限

---

## 📊 データベース設計思想

### excerpt_typeの保存
```sql
CREATE TABLE questions (
    id TEXT PRIMARY KEY,
    theme TEXT NOT NULL,
    excerpt_type TEXT,  -- 追加
    japanese_paragraphs TEXT,
    ...
);
```

### 偏り検知の実装
```python
def get_recent_excerpt_types(limit: int = 10) -> List[str]:
    """直近N問の抜粋タイプを取得"""
    
def should_avoid_excerpt_type(excerpt_type: str) -> bool:
    """直近10問で3回以上同じタイプなら避ける"""
```

#### なぜ偏り検知が必要か
1. **多様性の確保**: P1_ONLYばかりにならないように
2. **訓練効果**: すべての構成要素をバランスよく練習
3. **飽き防止**: 同じパターンの連続を避ける

---

## 🚫 設計上の禁止事項

### 1. 全文の出力禁止
❌ P1→P2→P3→P4と順に全段落を出さない  
✅ 抜粋部分のみを出力

### 2. 完結性の排除
❌ 導入→本論→結論が揃った完結文  
✅ 途中から始まってよい、結論がなくてもよい

### 3. 導入への偏り禁止
❌ P1_ONLYが50%以上  
✅ 中盤（方法/結果）からの開始を優先（P2_P3が50%）

### 4. 指示語の破綻禁止
❌ 「その研究」「このプログラム」だけで意味不明  
✅ 冒頭に最小限の前提（「ある研究の結果、」など）

### 5. 過去問の丸写し禁止
❌ 2025年度の問題をそのままコピー  
✅ 構造・雰囲気のみ参考、内容は新規生成

---

## 🎯 設計目標の達成度

### ✅ 実現できたこと
1. **ユーザー疲労の軽減**: 1〜2段落の適切な分量
2. **多様な訓練**: P1_ONLY/P2_P3/P3_ONLY/P4_P5で全構成要素をカバー
3. **抜粋感の再現**: 接続語、前提の最小化
4. **品質保証**: バリデーションとリトライで安定性確保
5. **UI明示化**: 抜粋タイプの表示でユーザー理解向上
6. **偏り防止**: DB記録で同パターンの連続を回避

### 🔄 今後の改善余地
1. **多様性の向上**: 現状P2_P3が多い → プロンプト調整
2. **偏り検知の活用**: `should_avoid_excerpt_type()`を生成時に使用
3. **段落ラベル**: 「段落①」「段落②」の明示（オプション）
4. **全文メタデータ**: full_structureフィールドの追加（検討中）

---

## 📖 設計の哲学

### 「抜粋」は欠陥ではなく特徴
- 情報不足は意図的なもの
- 文脈推測力を鍛える
- 実践的な訓練

### 「ユーザーファースト」の実践
- 疲れない分量
- 余計な装飾を排除
- 明確なフィードバック

### 「過去問に学ぶ」姿勢
- 実際の入試問題を徹底分析
- 構造を理解し、再現する
- 丸写しではなく、本質を捉える

---

## 🔬 検証方法

### 受け入れ条件
- [ ] `/api/question` で P1_ONLY, P2_P3, P3_ONLY が混ざる
- [x] 段落数が 1〜2中心（最大3）
- [x] UIに抜粋タイプが表示される
- [x] 生成失敗時はリトライで収束する
- [x] DBに excerpt_type が保存される

### 品質チェックポイント
1. **抜粋感があるか**: 接続語、前提の有無
2. **完結しすぎていないか**: 導入→結論の流れ
3. **段落数は適切か**: 1〜3段落
4. **文数は適切か**: 1段落5文以内
5. **タイプ整合性**: excerpt_typeと段落数が一致

---

## 📚 参考資料

### 実装ドキュメント
- [EXCERPT_IMPLEMENTATION_ISSUE.md](EXCERPT_IMPLEMENTATION_ISSUE.md): 問題点の詳細分析
- [EXCERPT_IMPLEMENTATION_TODO.md](EXCERPT_IMPLEMENTATION_TODO.md): 実装手順書

### 過去問データ
- 2025年度: 研究紹介（4段落構成）
- 2024年度: 時事（5段落構成）
- 2023年度: 学術（3段落構成）
- 2022年度: ブログ（5段落構成）
- 2021年度: レビュー（2段落構成）

### システムアーキテクチャ
- models.py: データモデルとバリデーション
- prompts_translation.py: 問題生成プロンプト
- llm_service.py: LLM呼び出しとリトライロジック
- database.py: データ永続化と偏り検知
- static/main.js: フロントエンド表示
- static/style.css: UIスタイル

---

**設計者**: fumichuki  
**最終更新**: 2026年1月29日  
**バージョン**: 1.0  
**ステータス**: 実装完了、運用開始

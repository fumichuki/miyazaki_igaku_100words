# 詳細バグレポート：文法・表現のポイント解説の項目数問題

以下、**agent にそのまま貼り付けて使える「問題点の詳細記載（＝バグレポート）」**です。
※今回の対象は **「💡 文法・表現のポイント解説」(= front の nonEvaluationPoints に出る部分)** の実装のみ。ここは作り直してOK。

---

## 0. 目的（今回"問題点として"確定させたいこと）

* **日本語4文**（原文）に対し、UIに表示される **「💡 文法・表現のポイント解説」= 4項目** が安定して出ること

  * UIは `level !== "内容評価"` の件数を「〜項目」として表示している（static/main.js:482-485）。
* **懸念ケース**も正しく扱うこと

  1. 日本語4文に対してユーザーが英文3文で提出（要約・統合）
  2. 日本語2文分を `, which ...` 等で **英文1文に統合**して提出
* いずれの場合も **ユーザーが納得する「理由（解説）」の品質**（語彙比較＋【参考】＋例文2つ）が担保されること。

---

## 1. 現象（再現する症状）

### 1-1. 画面上の表示

以下のように **ポイント解説が 1項目しか出ず**、しかも中身が固定文言の「エラー」になる。

```
💡 文法・表現のポイント解説（1項目）
1
💡 学生の表現
→
✅ より良い表現
添削処理中にエラーが発生しました。再度お試しください。
```

※重要：これは"本当の例外"ではなく、**バックエンドが任意条件で差し込んでいる固定フォールバック文言**の可能性が高い（後述）。

---

## 2. UI側の仕様（= バックエンドが満たすべき前提）

### 2-1. 項目数のカウント方法

* UIは `data.points.filter(p => p.level !== "内容評価").length` を数えて
  `💡 文法・表現のポイント解説（N項目）` と表示している（static/main.js:482-485）。
* つまり **非「内容評価」point が 4つあれば 4項目**になる。

### 2-2. 「内容評価」point が無いとどうなるか

* UIは `data.points.find(p => p.level === "内容評価")` がある場合だけ「全体評価」を表示する（static/main.js:420-478）。
* したがって、バックエンドが **「内容評価」point を返さない設計**でもUIは落ちないが、
  **今回の要件（ユーザー満足）としては、全体評価を常に出す or 少なくとも文法ポイント4つは必須**、という扱いにする。

---

## 3. バックエンド側の"確定している"問題点（コード根拠つき）

対象ファイル：`llm_service.py`

### 3-1. points が 3未満だと「固定のエラーポイント1件」に強制置換される

* `llm_service.py:1241-1249` にて、次の条件で points が丸ごと置換される：

```python
if 'points' not in correction_data or len(correction_data['points']) < 3:
    correction_data['points'] = [{
        "before": "学生の表現",
        "after": "より良い表現",
        "reason": "添削処理中にエラーが発生しました。再度お試しください。",
        "level": "💡改善提案"
    }]
```

**問題点**

1. LLMが points を 1〜2 個しか返さないだけで、**"実際は添削できている"のにエラー表示になる**（誤誘導）
2. しかも **1件固定**なので、UIの項目数は必ず 1 になる
3. 「内容評価」point も入っていないので、全体評価表示も出ない
4. 置換により、もし LLM が 2個だけでも有益な指摘を返していた場合、それすら消える（破壊的）

> 結論：この分岐がある限り、LLMが "最低3件以上の points" を返さないと **必ずユーザーにエラーが出る**。

---

### 3-2. points "個数要件"が「3」という固定値で、UI要件（4文→4項目）と一致していない

* 本来、4文なら **非「内容評価」point は4つ必要**（場合によっては＋「内容評価」1つで合計5）。
* しかし現実には「3未満なら置換」という雑な条件なので、

  * 4文でも points が 2個返ったら即置換→1項目
  * points が 3個返っても、非「内容評価」が2個しかないなど、UI要件を満たさない可能性が残る

---

### 3-3. 「before が空」な point は除外され、結果として項目数が減る（しかも再補完が無い）

* `llm_service.py:1251-1270` で、before が空だとスキップして `valid_points` のみにする。

**問題点**

1. LLMが形式を少し崩して before を空にしただけで、**point が削られて項目数が減る**
2. フィルタ後に「4項目あるか？」等の再検証が無い
3. その結果、運良く 3件以上で置換分岐を回避しても、フィルタ後に **1〜2件に減って UI が崩れる**可能性がある

---

## 4. プロンプト側の"仕様ズレ"が points の少数出力を誘発している

対象：`prompts_translation_simple.py`

### 4-1. points の個数を「最低1個」としか要求していない

* プロンプト内に「points は最低1個以上」とあるが、**4文→4項目**のような個数強制が無い。
  → LLMが 1個だけ返すのは仕様上あり得る。
  → その場合、バックエンド側で `len(points)<3` に引っかかり、例の"エラー1件置換"が発動する。

### 4-2. level の仕様も不統一（prompt と backend fallback が矛盾）

* prompt は level を「✅/❌のみ（💡は使わない）」と書いている一方、
  backend の置換は level="💡改善提案" を返す。
* UIは level文字列を見て表示を変える実装があるため、**この不一致は UI 表示の不安定要因**。

---

## 5. 仕様として明文化すべき "文数ズレ" ケース（今回の重要要件）

### 5-1. 日本語4文に対して英文3文で提出（要約・統合）

* 例：原文4文 → 学生答案3文
* **必要な挙動（要件）**

  * UIの「ポイント解説」は **3項目になるのが自然**（英文の実文数ベース）か、または **4項目（原文文数ベース）**を維持するか、方針を決めて実装する必要がある
  * どちらにしても、**現状の「1項目になる」挙動は明確にNG**

### 5-2. 日本語2文を `, which ...` で英文1文に統合

* 例：日本語2文 → 英文1文（関係節/分詞構文で統合）
* **必要な挙動（要件）**

  * 統合された英文1文に対して **1項目の解説**を出す（英文文数ベース）
  * ただし解説内で「2文分の内容を統合している」ことを説明できるのが理想

---

## 6. ユーザーが求める「解説品質」の要件（reason の中身）

今回の "文法・表現のポイント解説" は、下記の形式（語彙比較＋【参考】＋例文2つ）を満たす必要がある。
（= ここが満たせないなら、出力が4項目でもユーザー満足が出ない）

必須要素：

* 英文（対象文）
* 日本語訳（括弧内）
* 語彙・表現の比較：`A（品詞：意味：文脈）／B（…）で違い説明`
* 【参考】：パターン提示
* 例文2つ（英＋和）

---

## 7. まとめ（"今起きている問題"の核心）

1. **LLMが points を少数（1〜2個）で返すのは現行プロンプト上あり得る**
2. しかし backend が `len(points)<3` をトリガに **points を"エラー1件"へ強制置換**しているため、UIは必ず **1項目**になり、しかもユーザーに誤ったエラー表示を出す
3. さらに before 空除外で points が減る可能性があり、**項目数が安定しない**
4. UI要件（4文→4項目）と、prompt/backend の points 設計が噛み合っていない（仕様ズレ）

---

## 8. agent にやってほしいこと（= 次段の設計検討に必要な事実収集）

※ここから先は「実装案」ではなく、**仕様確定に必要な"問題点の裏取り"**。

* [ ] 上記のコード箇所（llm_service.py:1241-1249, 1251-1270 / main.js:482-492）を根拠として、**なぜ 1項目になるのか**を再現ログ付きで説明する
* [ ] LLMが points を 1〜2個しか返さないケースを実際に確認（プロンプトがそう要求していないため）
* [ ] 文数ズレ（4→3、2→1統合）をテスト入力で再現し、現状の points 出力がどう崩れるかを記録
* [ ] 「4文→4項目」を満たすには、(A) 原文文数ベース / (B) 英文文数ベース / (C) ハイブリッド のどれを採用するか、**仕様として決めないと実装できない**点を明文化する

---
